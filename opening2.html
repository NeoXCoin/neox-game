<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>NeoX Catch â€” Opening 2</title>

<!-- âœ… å®ˆé–€ï¼ˆA+Bï¼‰ï¼šå…è¨± #fromV1 æ”¾è¡Œä¸¦è£œå¯«é€²åº¦ï¼›å¦å‰‡è¦æ±‚ last_level â‰¥ 1 -->
<script>
(function(){
  const HUB          = 'https://neoxcoin.github.io/neox-game/';
  const ORIGIN_ALLOW = 'https://neoxcoin.github.io';
  const L1_URL       = HUB + 'v1.html';

  // é˜²ç†±éˆï¼šå¦‚è¢«å¤–ç«™ iframe è¼‰å…¥ï¼Œå› Hub
  if (window.top !== window.self) {
    try {
      const ref = document.referrer || '';
      const origin = ref ? new URL(ref).origin : '';
      if (origin !== ORIGIN_ALLOW) {
        window.top.location.replace(HUB);
        return;
      }
    } catch (e) {
      window.top.location.replace(HUB);
      return;
    }
  }

  // æ”¾è¡Œæ¢ä»¶
  const safeNum = k => { try { return Number(localStorage.getItem(k) || 0); } catch { return 0; } };
  const lastLv  = safeNum('neox_last_level');
  const fromV1  = /fromV1/i.test(location.hash || '');

  if (fromV1) {
    try { localStorage.setItem('neox_last_level', '1'); } catch(e){}
    return; // ç›´å…¥
  }

  if (lastLv < 1) {
    location.replace(L1_URL + '#fromGuard');
    return;
  }
})();
</script>

<style>
  :root{ --pad: clamp(10px, 3.5vw, 18px); }

  html, body {
    margin: 0; height: 100%;
    background: #000; color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang TC", "Noto Sans", Arial, sans-serif;
    overflow: hidden;
  }

  #wrap {
    position: fixed; inset: 0;
    display: grid; place-items: center;
    height: 100vh; height: 100svh; height: 100dvh;
    background: #000 url('TreasureL2.png') center / contain no-repeat;
  }

  /* å½±ç‰‡é¡¯ç¤ºè¨­å®š */
  #introVideo {
    position: absolute; inset: 0; width: 100%; height: 100%;
    object-fit: contain; object-position: center center;
    background: #000 url('TreasureL2.png') center/contain no-repeat;
    transition: opacity .4s ease;
    opacity: 0;
  }
  #introVideo.loaded { opacity: 1; }

  /* æ§åˆ¶å±¤ï¼ˆæœƒè‡ªå‹•æ·¡å‡ºï¼‰ */
  .overlay {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    justify-content: flex-end; align-items: center; text-align: center;
    background: linear-gradient(transparent 60%, rgba(0,0,0,.7));
    padding-bottom: calc(var(--pad) + env(safe-area-inset-bottom));
    transition: opacity .35s ease;
    opacity: 1;
  }
  .overlay.hide{ opacity: 0; pointer-events: none; }

  h1 {
    margin: 0 0 8px; font-size: clamp(22px, 6vw, 34px); font-weight: 900;
    letter-spacing: .02em; text-shadow: 0 0 22px rgba(43,124,255,.45);
  }
  p  { margin: 0 0 14px; font-size: 15px; color: #cfd5ff; }

  /* === æŒ‰éˆ•æ’ç‰ˆ === */
  .btnrow { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }

  /* === æŒ‰éˆ•çµ±ä¸€æ¨£å¼ï¼ˆèˆ‡ Opening3 ä¸€è‡´ï¼‰ === */
  .btnrow button{
    appearance: none;
    border: 0; border-radius: 14px;
    padding: 12px 18px;
    font-weight: 800; letter-spacing: .02em;
    color: #fff;
    background: linear-gradient(180deg, #2c3363 0%, #1a1f40 100%);
    box-shadow: 0 10px 28px rgba(0,0,0,.4),
                inset 0 0 0 1px rgba(255,255,255,.08);
    cursor: pointer;
    transition: transform .15s ease, box-shadow .25s ease, filter .25s ease;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .btnrow button:hover{
    transform: translateY(-2px);
    filter: brightness(1.15);
    box-shadow: 0 14px 34px rgba(43,124,255,.35),
                inset 0 0 0 1px rgba(255,255,255,.12);
  }
  .btnrow button:active{
    transform: translateY(0);
    filter: brightness(.95);
    box-shadow: 0 8px 18px rgba(0,0,0,.35);
  }
  .btnrow button:focus-visible{
    outline: none;
    box-shadow:
      0 0 0 3px rgba(43,124,255,.25),
      0 0 0 6px rgba(43,124,255,.2),
      0 10px 28px rgba(0,0,0,.4),
      inset 0 0 0 1px rgba(255,255,255,.1);
  }

  /* ä¸»æŒ‰éˆ•ï¼ˆStartï¼‰ */
  .primary{
    background: linear-gradient(180deg, #4c8dff 0%, #2b7cff 70%, #236cf0 100%);
    box-shadow: 0 0 25px rgba(43,124,255,.25),
                0 10px 28px rgba(0,0,0,.4),
                inset 0 0 0 1px rgba(255,255,255,.15);
  }
  .primary:hover{
    filter: brightness(1.2);
    box-shadow: 0 0 30px rgba(43,124,255,.4),
                0 12px 32px rgba(0,0,0,.45);
  }

  @media (max-width:500px){
    .btnrow button{ padding: 11px 14px; font-size: 14px; }
  }
</style>
</head>
<body>
  <section id="wrap">
    <video
      id="introVideo"
      src="https://neoxcoin.github.io/neox-game/CatchCoinL2.mp4"
      poster="TreasureL2.png"
      preload="auto" muted playsinline webkit-playsinline
    ></video>

    <div class="overlay" id="overlay">
      <h1>Treasure Journey</h1>
      <p>Watch the short opening, or skip and start the level.</p>
      <div class="btnrow">
        <button id="btnSound">ğŸ”ˆ Sound off</button>
        <button id="btnStart" class="primary">â–¶ Start Play</button>
        <button id="btnSkip">â­ Skip</button>
      </div>
    </div>
  </section>

<script>
/* ===== DOM ===== */
const video    = document.getElementById('introVideo');
const overlay  = document.getElementById('overlay');
const btnSound = document.getElementById('btnSound');
const btnStart = document.getElementById('btnStart');
const btnSkip  = document.getElementById('btnSkip');

/* é¡¯ç¤ºç¬¬ä¸€å¹€ï¼ˆé˜²é»‘å±ï¼‰ */
function reveal(){ video.classList.add('loaded'); }
video.addEventListener('loadeddata', reveal);
video.addEventListener('loadedmetadata', reveal);
video.play().catch(()=>{}); // å˜—è©¦éœéŸ³è‡ªå‹•æ’­æ”¾

/* ===== è‡ªå‹•æ”¶èµ·æ§åˆ¶å±¤ï¼ˆèˆ‡ Opening3 ä¸€æ¨£ï¼‰ ===== */
let hideTimer = null;
function scheduleHide(){
  clearTimeout(hideTimer);
  hideTimer = setTimeout(()=> overlay.classList.add('hide'), 5000);
}
function showControls(){
  overlay.classList.remove('hide');
  scheduleHide();
}
scheduleHide(); // åˆå§‹ 5 ç§’å€’æ•¸
['mousemove','pointermove','pointerdown','touchstart','keydown'].forEach(evt=>{
  window.addEventListener(evt, showControls, { passive: true });
});

/* ===== iPhone è§£é–ï¼šé¦–æ¬¡äº’å‹•ç¢ºä¿å¯æ’­æ”¾ ===== */
['pointerdown','touchend','click','keydown'].forEach(evt=>{
  window.addEventListener(evt, async ()=>{
    if(video.paused){ try{ await video.play(); }catch(e){} }
  }, { once:true, passive:true });
});

/* ===== è²éŸ³é–‹/é—œï¼ˆåˆ‡æ›æ–‡æ¡ˆï¼‰ ===== */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function updateSoundLabel(){
  btnSound.textContent = video.muted ? 'ğŸ”ˆ Sound off' : 'ğŸ”Š Sound on';
}
btnSound.addEventListener('click', async ()=>{
  ensureAudio();
  try{
    await audioCtx.resume();
    video.muted = !video.muted;
    if(!video.muted && video.paused){ try{ await video.play(); }catch(e){} }
    updateSoundLabel();
  }catch(e){}
});
updateSoundLabel();

/* ===== Startï¼šå…ˆå˜—è©¦æ’­æ”¾ï¼›è‹¥ 1.2s å…§ç„¡åæ‡‰ â†’ ç›´æ¥é–‹ MP4 ===== */
async function tryPlayWithFallback(){
  try{ ensureAudio(); await audioCtx?.resume?.(); }catch(e){}
  let started = false;
  const onPlaying = ()=>{ started = true; cleanup(); };
  const onTime = ()=>{ if (video.currentTime > 0) { started = true; cleanup(); } };
  function cleanup(){
    video.removeEventListener('playing', onPlaying);
    video.removeEventListener('timeupdate', onTime);
  }
  video.addEventListener('playing', onPlaying, { once:true });
  video.addEventListener('timeupdate', onTime);

  try{ await video.play(); }catch(e){ /* ignore */ }

  setTimeout(()=>{
    if(!started){
      cleanup();
      // ç”¨çµ•å°è·¯å¾‘æ‰“é–‹åŸå§‹ mp4ï¼ˆç³»çµ±æ’­æ”¾å™¨ï¼‰
      location.href = 'https://neoxcoin.github.io/neox-game/CatchCoinL2.mp4';
    }
  }, 1200);
}
btnStart.addEventListener('click', tryPlayWithFallback);

/* ===== Skip / å½±ç‰‡æ’­å®Œ â†’ é€² v2.htmlï¼ˆA+Bï¼‰ ===== */
const V2_URL = 'https://neoxcoin.github.io/neox-game/v2.html#fromOpening2';
function goV2(){
  // A: è£œå¯«é€²åº¦ï¼Œç¢ºä¿å·²é€šé L1
  try { localStorage.setItem('neox_last_level', '1'); } catch(e){}
  // B: é ‚å±¤è·³è½‰ï¼Œé¿å… iframe æ””æˆªï¼›å¤±æ•—å‰‡é€€å›æœ¬å±¤
  try{
    if (window.top && window.top !== window) {
      window.top.location.href = V2_URL;
    } else {
      location.replace(V2_URL);
    }
  }catch(e){
    location.href = V2_URL;
  }
}
btnSkip.addEventListener('click', goV2);
video.addEventListener('ended', goV2);

/* å›å¯è¦–æ™‚ç¶­æŒæ’­æ”¾ */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible' && video.paused){
    video.play().catch(()=>{});
  }
});
</script>
</body>
</html>