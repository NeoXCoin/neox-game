<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Catch ‚Äî Level 3</title>
<style>
  html,body{
    height:100%;margin:0;background:#000;color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;
    overflow:hidden;
  }
  #wrap{position:relative;height:100%;display:grid;place-items:center}

  /* ËÉåÊôØÂΩ±ÁâáÔºà‰∏çË£ÅÂàáÔºâ */
  .bgvid{
    position:absolute;inset:0;display:grid;place-items:center;
    z-index:0;pointer-events:none;background:#000;
  }
  .bgvid video{
    width:min(92vw,700px);aspect-ratio:9/16;height:auto;
    object-fit:contain;border-radius:16px;background:#000;
  }

  canvas{
    display:block;width:min(92vw,700px);aspect-ratio:9/16;height:auto;
    border-radius:16px;background:transparent;
    box-shadow:0 22px 60px rgba(0,0,0,.45), inset 0 0 1px rgba(255,255,255,.06);
    touch-action:none;position:relative;z-index:2;
  }

  /* HUD */
  .hud{position:absolute;inset:0;z-index:5;pointer-events:none;display:grid;grid-template-rows:auto 1fr}
  .topbar{display:grid;grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);align-items:start;
          gap:10px;padding:10px 14px;font-weight:800}
  .left{justify-self:start;pointer-events:auto}
  .center{justify-self:center;text-align:center;pointer-events:none}
  .right{justify-self:end;pointer-events:auto}
  .badge{display:inline-block;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.14);
         backdrop-filter:blur(3px);box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
         margin:0 6px;font-weight:900}
  .iconbtn{display:inline-flex;align-items:center;gap:8px;background:#1b2144;border:0;color:#fff;border-radius:14px;
           padding:10px 14px;font-weight:800;box-shadow:0 10px 28px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.08);
           cursor:pointer}
  .iconbtn img{width:22px;height:22px;object-fit:contain;display:block}

  /* Game Complete Èù¢Êùø */
  .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    min-width:clamp(240px,80%,520px);padding:20px 16px;border-radius:16px;text-align:center;
    background:rgba(10,12,34,.75);box-shadow:0 20px 60px rgba(0,0,0,.5),
    inset 0 0 0 1px rgba(255,255,255,.08);backdrop-filter:blur(6px);z-index:15;
    opacity:0;transition:opacity .6s ease;}
  .panel.show{opacity:1}
  .panel h1{margin:8px 0 10px;font-size:clamp(22px,5.2vw,30px)}
  .panel p{margin:0 0 14px;color:#c8d2ff}
  .row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;color:#fff;background:#2b7cff;
       box-shadow:0 8px 22px rgba(43,124,255,.35)}
  .btn.alt{background:#1f2648;box-shadow:inset 0 0 0 1px rgba(255,255,255,.1)}
  .hidden{display:none!important}

  @media (max-width:600px){
    .topbar{position:relative;display:block;padding:10px 14px}
    .topbar .left{position:absolute;left:10px;top:10px}
    .topbar .right{position:absolute;right:10px;top:10px}
    .topbar .center{position:absolute;left:50%;top:10px;transform:translateX(-50%);pointer-events:none}
  }
</style>
</head>
<body>
<div id="wrap">
  <div class="bgvid"><video id="bgVideo" muted loop playsinline webkit-playsinline preload="auto"
    src="https://neoxcoin.github.io/neox-game/V3backgroundAnimation.mp4"
    poster="https://neoxcoin.github.io/neox-game/V3background.png.PNG"></video></div>

  <canvas id="game" width="450" height="800"></canvas>

  <div class="hud">
    <div class="topbar">
      <div class="left">
        <button id="btnHome" class="iconbtn">
          <img src="https://neoxcoin.github.io/neox-game/XNXC.png" alt="Home"/>Home
        </button>
      </div>
      <div class="center">
        <span class="badge" id="scoreBadge">Score: 0</span>
        <span class="badge" id="timeBadge">Time: 03:00</span>
        <span class="badge" id="bestBadge">Best: 0</span>
      </div>
      <div class="right">
        <button id="btnPause" class="iconbtn">‚è∏ Pause</button>
      </div>
    </div>

    <div id="panelWin" class="panel hidden">
      <h1>Game Complete üéâ</h1>
      <p><span id="finalScore">Score: 0</span> ¬∑ <span id="bestScore">Best: 0</span></p>
      <div class="row">
        <button id="btnReplay" class="btn alt">‚Üª Replay</button>
        <button id="btnFinish" class="btn">Finish</button>
      </div>
    </div>
  </div>
</div>

<script>
const TOTAL_TIME_SEC=180,MISS_PENALTY=5;
const CHEST_URL="https://neoxcoin.github.io/neox-game/treasure-box.png";
const COIN_URL="https://neoxcoin.github.io/neox-game/neox-emoji-128.png";
const RUBY_URL="https://neoxcoin.github.io/neox-game/ruby.png";
const SAPPH_URL="https://neoxcoin.github.io/neox-game/sapphire.png";

const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
function fitHiDPI(){const cssW=canvas.clientWidth,cssH=canvas.clientHeight,dpr=Math.min(window.devicePixelRatio||1,2);
if(canvas.width!==Math.round(cssW*dpr)){canvas.width=Math.round(cssW*dpr);canvas.height=Math.round(cssH*dpr);}
ctx.setTransform(dpr,0,0,dpr,0,0);}
fitHiDPI();addEventListener("resize",fitHiDPI);

const State={PLAYING:1,PAUSED:2,WIN:3};let state=State.PLAYING;
const scoreBadge=document.getElementById("scoreBadge"),
bestBadge=document.getElementById("bestBadge"),
timeBadge=document.getElementById("timeBadge"),
panelWin=document.getElementById("panelWin"),
finalScore=document.getElementById("finalScore"),
bestScore=document.getElementById("bestScore"),
btnPause=document.getElementById("btnPause"),
btnFinish=document.getElementById("btnFinish");

const bgVideo=document.getElementById("bgVideo");
bgVideo.play().catch(()=>{});
let carry=+localStorage.getItem("nx_carry")||0,score=carry,
best=+localStorage.getItem("neox_catch_best_l3")||0,timeLeft=TOTAL_TIME_SEC;

function fmt(t){const m=Math.floor(t/60),s=Math.floor(t%60);return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`}
function refreshHUD(){scoreBadge.textContent=`Score: ${Math.floor(score)}`;bestBadge.textContent=`Best: ${best}`;timeBadge.textContent=`Time: ${fmt(timeLeft)}`;finalScore.textContent=`Score: ${score}`;bestScore.textContent=`Best: ${best}`;}

const chestImg=new Image();chestImg.src=CHEST_URL;
const coinImg=new Image();coinImg.src=COIN_URL;
const rubyImg=new Image();rubyImg.src=RUBY_URL;
const sappImg=new Image();sappImg.src=SAPPH_URL;

const EDGE=2,chest={x:canvas.clientWidth/2,y:0,w:220,h:160,speed:6.5,vx:0};
function placeChest(){const H=canvas.clientHeight;const targetW=Math.min(canvas.clientWidth*0.3,280);
chest.w=targetW;chest.h=Math.round(targetW*0.72);chest.y=H-20;chest.x=Math.max(chest.w/2+EDGE,Math.min(chest.x,canvas.clientWidth-chest.w/2-EDGE));}
placeChest();addEventListener("resize",placeChest);

const keys=new Set();addEventListener("keydown",e=>{if(e.key==="ArrowLeft")keys.add("L");if(e.key==="ArrowRight")keys.add("R");if(e.key.toLowerCase()==="p")togglePause();});
addEventListener("keyup",e=>{if(e.key==="ArrowLeft")keys.delete("L");if(e.key==="ArrowRight")keys.delete("R");});
let pointerId=null;canvas.addEventListener("pointerdown",e=>{pointerId="p";e.preventDefault();});
addEventListener("pointermove",e=>{if(!pointerId)return;const rect=canvas.getBoundingClientRect(),cx=(e.clientX-rect.left)/rect.width*canvas.clientWidth,diff=cx-chest.x;chest.vx=Math.max(-chest.speed,Math.min(chest.speed,diff*0.25));});
addEventListener("pointerup",()=>{pointerId=null;chest.vx=0;});

function togglePause(){if(state===State.PLAYING){state=State.PAUSED;btnPause.textContent="‚èµ Resume";}else{state=State.PLAYING;btnPause.textContent="‚è∏ Pause";}}

document.getElementById("btnHome").onclick=()=>location.href="index.html";
document.getElementById("btnReplay").onclick=()=>restart();
btnFinish.onclick=()=>{const s=Math.floor(score),b=Math.floor(best);location.href=`endgame.html?score=${s}&best=${b}`;};
btnPause.onclick=()=>togglePause();

let audioCtx;function beep(f){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type="sine";o.frequency.value=f;g.gain.value=.2;o.connect(g).connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+.1);}
addEventListener("click",()=>{if(!audioCtx){audioCtx=new AudioContext();bgVideo.play().catch(()=>{});}});

const items=[],TYPES={COIN:"coin",RUBY:"ruby",SAPP:"sapp"},SCORE_MAP={coin:10,ruby:50,sapp:100},SIZE_MAP={coin:28,ruby:34,sapp:38};
let spawnTimer=0;
function spawn(dt){spawnTimer-=dt;if(spawnTimer<=0&&items.length<6){const SAFE=chest.w*0.12,r=Math.random(),type=r<.6?TYPES.COIN:(r<.82?TYPES.RUBY:TYPES.SAPP);
items.push({type,x:EDGE+SAFE+Math.random()*(canvas.clientWidth-2*(EDGE+SAFE)),y:-20,vy:2.5+Math.random()*2.2,rot:Math.random()*Math.PI*2,vrot:-.14+Math.random()*.28});
spawnTimer=.5+Math.random()*.6;}}
function finish(){state=State.WIN;best=Math.max(best,score);localStorage.setItem("neox_catch_best_l3",best);localStorage.setItem("nx_last_score",score);refreshHUD();panelWin.classList.remove("hidden");requestAnimationFrame(()=>panelWin.classList.add("show"));}
function restart(){score=carry;timeLeft=TOTAL_TIME_SEC;items.length=0;spawnTimer=0;state=State.PLAYING;panelWin.classList.add("hidden");panelWin.classList.remove("show");refreshHUD();}

let last=performance.now();function loop(now){requestAnimationFrame(loop);fitHiDPI();const dt=Math.min(50,now-last)/16.6;last=now;
drawScene();if(state===State.PLAYING){timeLeft=Math.max(0,timeLeft-dt/60);if(timeLeft<=0){finish();return;}
chest.vx=(keys.has("L")?-chest.speed:0)+(keys.has("R")?chest.speed:0)||chest.vx*.92;chest.x=Math.max(chest.w/2,Math.min(canvas.clientWidth-chest.w/2,chest.x+chest.vx));
spawn(dt);for(const it of items){it.y+=it.vy*dt;it.rot+=it.vrot*dt;}
const mouth={cx:chest.x,cy:chest.y-chest.h*.58,rx:chest.w*.36,ry:chest.h*.18};
for(let i=items.length-1;i>=0;i--){const it=items[i],r=SIZE_MAP[it.type]/2,ex=(it.x-mouth.cx)/mouth.rx,ey=(it.y-mouth.cy)/mouth.ry;
if(ex*ex+ey*ey<=1){score+=SCORE_MAP[it.type];items.splice(i,1);beep(880);refreshHUD();}
else if(it.y>canvas.clientHeight+30){score=Math.max(0,score-MISS_PENALTY);items.splice(i,1);beep(240);refreshHUD();}}}}
requestAnimationFrame(loop);

function drawScene(){ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
const g=ctx.createRadialGradient(chest.x,chest.y-24,6,chest.x,chest.y-24,120);g.addColorStop(0,"rgba(43,124,255,.3)");g.addColorStop(1,"rgba(43,124,255,0)");
ctx.fillStyle=g;ctx.beginPath();ctx.arc(chest.x,chest.y-24,90,0,Math.PI*2);ctx.fill();
drawChest();drawItems();}
function drawChest(){ctx.save();ctx.drawImage(chestImg,chest.x-chest.w/2,chest.y-chest.h,chest.w,chest.h);ctx.restore();}
function drawItems(){for(const it of items){const s=SIZE_MAP[it.type],r=s/2;ctx.save();ctx.translate(it.x,it.y);ctx.rotate(it.rot);
let img=it.type==="coin"?coinImg:it.type==="ruby"?rubyImg:sappImg;ctx.drawImage(img,-r,-r,s,s);ctx.restore();}}
refreshHUD();
</script>
</body>
</html>