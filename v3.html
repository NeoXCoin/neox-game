<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Catch â€” Level 3</title>
<style>
  html,body{
    height:100%; margin:0; color:#fff;
    background:#070a18;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;
    overflow:hidden;
  }
  #wrap{position:relative;height:100%;display:grid;place-items:center}

  /* ä¸­å¤®èˆå° */
  .stage{
    position:relative;
    width:min(92vw,700px);
    aspect-ratio:9/16;
    border-radius:16px;
    box-shadow:0 22px 60px rgba(0,0,0,.45), inset 0 0 1px rgba(255,255,255,.06);
    overflow:hidden;
  }

  /* èƒŒæ™¯å½±ç‰‡ */
  .bgvid{position:absolute;inset:0;z-index:0;display:grid;place-items:center;pointer-events:none}
  .bgvid video{
    width:100%;height:100%;
    object-fit:contain;
    background:#000;
  }
  .bgvid video,
  .stage canvas { object-position:center center; }

  /* éŠæˆ²ç•«å¸ƒ */
  canvas{
    position:absolute;inset:0;z-index:2;
    width:100%;height:100%;
    display:block;border-radius:16px;
    background:transparent;touch-action:none;
  }

  /* HUD */
  .hud{position:absolute;inset:0;z-index:5;pointer-events:none;display:grid;grid-template-rows:auto 1fr}
  .topbar{
    display:grid;
    grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);
    align-items:center;
    gap:10px;
    padding:calc(10px + env(safe-area-inset-top)) 14px 10px;
  }
  .left{justify-self:start;pointer-events:auto}
  .center{justify-self:center;text-align:center;pointer-events:none}
  .right{justify-self:end;pointer-events:auto}
  .badge{display:inline-block;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.14);backdrop-filter:blur(3px);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);margin:0 6px;font-weight:900}
  .iconbtn{display:inline-flex;align-items:center;gap:8px;background:#1b2144;border:0;color:#fff;border-radius:14px;padding:10px 14px;
    font-weight:800;box-shadow:0 10px 28px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.08);cursor:pointer;pointer-events:auto}
  .iconbtn img{width:22px;height:22px;object-fit:contain;display:block}

  /* çµæŸé¢æ¿ */
  .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:auto;min-width:clamp(240px,80%,520px);
    text-align:center;padding:18px 16px 20px;border-radius:16px;background:rgba(10,12,34,.82);
    box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.08);backdrop-filter:blur(4px);z-index:15}
  .panel h1{margin:8px 0 10px;font-size:clamp(22px,5.2vw,30px)}
  .panel p{margin:0 0 14px;color:#c8d2ff;font-size:14px;line-height:1.55}
  .row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;color:#fff;background:#2b7cff;
    box-shadow:0 8px 22px rgba(43,124,255,.35)}
  .btn.alt{background:#1f2648;box-shadow:inset 0 0 0 1px rgba(255,255,255,.1)}
  .hidden{display:none !important}

  /* é–‹å ´å‹•ç•« */
  #opening{position:absolute;inset:0;z-index:20;display:grid;place-items:center;background:transparent}
  #opVideo{
    width:100%;height:100%;object-fit:contain;border-radius:16px;background:#000;opacity:0;transition:opacity .6s;
    box-shadow:0 22px 60px rgba(0,0,0,.45), inset 0 0 1px rgba(255,255,255,.06);
  }
  .opOverlay {
    position: absolute;
    left: 0; right: 0;
    bottom: 10%;
    display: flex;
    justify-content: center;
    gap: 14px;
    padding: 12px 10px;
    text-align: center;
    background: linear-gradient(transparent 50%, rgba(0, 0, 0, 0.65));
    backdrop-filter: blur(6px);
    z-index: 25;
    transition: opacity .35s ease;
  }
  .opOverlay.hide{opacity:0;pointer-events:none;}
  .opOverlay h2{margin:.2em 0 .2em;font-weight:900;font-size:clamp(22px,6vw,36px)}
  .opOverlay p{margin:0 0 12px;color:#cbd5ff;font-weight:700}
  #opening.fadeout{animation:fadeOut .6s ease forwards}
  @keyframes fadeOut{to{opacity:0;visibility:hidden}}
</style>
</head>
<body>
<div id="wrap">
  <div class="stage">

    <!-- èƒŒæ™¯å½±ç‰‡ -->
    <div class="bgvid">
      <video id="bgVideo" muted loop playsinline preload="auto"
        src="https://neoxcoin.github.io/neox-game/V3backgroundAnimation.mp4"></video>
    </div>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="game" width="450" height="800"></canvas>

    <!-- HUD -->
    <div class="hud">
      <div class="topbar">
        <div class="left">
          <button id="btnHome" class="iconbtn">
            <img src="https://neoxcoin.github.io/neox-game/XNXC.png" alt="Home"/>Home
          </button>
        </div>
        <div class="center">
          <span class="badge" id="scoreBadge">Score: 0</span>
          <span class="badge" id="timeBadge">Time: 03:00</span>
          <span class="badge" id="bestBadge">Best: 0</span>
        </div>
        <div class="right">
          <button id="btnPause" class="iconbtn">â¸ Pause</button>
        </div>
      </div>

      <!-- çµç®— -->
      <div id="panelWin" class="panel hidden">
        <h1>Game Complete! ğŸ‰</h1>
        <p><span id="finalScore">Score: 0</span> Â· <span id="bestScore">Best: 0</span></p>
        <div class="row">
          <button id="btnReplay" class="btn alt">âŸ² Replay</button>
          <button id="btnFinish" class="btn">Finish</button>
        </div>
      </div>
    </div>

    <!-- é–‹å ´å‹•ç•« -->
    <section id="opening">
      <video id="opVideo" playsinline muted preload="auto"
        src="https://neoxcoin.github.io/neox-game/TreasureL3Opening.mp4"></video>
      <div class="opOverlay" id="opCtrl" style="visibility:hidden">
        <div>
          <h2>Level 3</h2>
          <p>Catch coins & gems. Avoid misses!</p>
          <div class="row">
            <button id="opSound" class="btn">ğŸ”ˆ Sound on</button>
            <button id="opPlay" class="btn">â–¶ Play</button>
            <button id="opSkip" class="btn alt">â­ Skip</button>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const TOTAL_TIME_SEC = 180;
const CHEST_URL="https://neoxcoin.github.io/neox-game/treasure-box.png";
const COIN_URL ="https://neoxcoin.github.io/neox-game/neox-emoji-128.png";
const RUBY_URL ="https://neoxcoin.github.io/neox-game/ruby.png";
const SAPP_URL ="https://neoxcoin.github.io/neox-game/sapphire.png";

const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const bgVideo=document.getElementById('bgVideo');
const scoreBadge=document.getElementById('scoreBadge');
const bestBadge=document.getElementById('bestBadge');
const timeBadge=document.getElementById('timeBadge');
const panelWin=document.getElementById('panelWin');
const finalScore=document.getElementById('finalScore');
const bestScore=document.getElementById('bestScore');
const btnPause=document.getElementById('btnPause');
const btnReplay=document.getElementById('btnReplay');
const btnFinish=document.getElementById('btnFinish');

/* ===== é–‹å ´å‹•ç•« ===== */
const opening=document.getElementById('opening');
const opVideo=document.getElementById('opVideo');
const opCtrl=document.getElementById('opCtrl');
const opSoundBtn=document.getElementById('opSound');
const opPlayBtn=document.getElementById('opPlay');
const opSkipBtn=document.getElementById('opSkip');

/* HiDPI */
function fitHiDPI(){
  const cssW=canvas.clientWidth, cssH=canvas.clientHeight;
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,2));
  if(canvas.width!==Math.round(cssW*dpr)){
    canvas.width=Math.round(cssW*dpr);
    canvas.height=Math.round(cssH*dpr);
  }
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
fitHiDPI(); addEventListener('resize',fitHiDPI);

const State={READY:0,PLAYING:1,PAUSED:2,WIN:3};
let state=State.READY;
let carry=Number(localStorage.getItem('nx_carry')||0);
let score=carry;
let best=Number(localStorage.getItem('neox_catch_best_l3')||0);
let timeLeft=TOTAL_TIME_SEC;

function fmt(t){const m=Math.floor(t/60),s=Math.floor(t%60);return`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
function refreshHUD(){
  scoreBadge.textContent=`Score: ${Math.floor(score)}`;
  bestBadge.textContent=`Best: ${Math.floor(best)}`;
  timeBadge.textContent=`Time: ${fmt(timeLeft)}`;
  finalScore.textContent=`Score: ${Math.floor(score)}`;
  bestScore.textContent=`Best: ${Math.floor(best)}`;
}

/* å½±åƒè³‡æº */
const chestImg=new Image(); chestImg.src=CHEST_URL;
const coinImg =new Image(); coinImg.src =COIN_URL;
const rubyImg =new Image(); rubyImg.src =RUBY_URL;
const sappImg =new Image(); sappImg.src =SAPP_URL;
let chestReady=false,coinReady=false,rubyReady=false,sappReady=false;
chestImg.onload=()=>chestReady=true;
coinImg.onload=()=>coinReady=true;
rubyImg.onload=()=>rubyReady=true;
sappImg.onload=()=>sappReady=true;

/* ç©å®¶ */
const EDGE=2;
const chest={x:canvas.clientWidth/2,y:0,w:220,h:160,speed:6.5,vx:0};
function placeChest(){
  const targetW=Math.min(canvas.clientWidth*0.28,280);
  chest.w=targetW;chest.h=Math.round(targetW*0.72);
  chest.y=canvas.clientHeight-30;
}
placeChest(); addEventListener('resize',placeChest);

/* è¼¸å…¥ */
const keys=new Set();
addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft')keys.add('L');
  if(e.key==='ArrowRight')keys.add('R');
});
addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft')keys.delete('L');
  if(e.key==='ArrowRight')keys.delete('R');
});

/* è²éŸ³ */
let audioCtx=null,masterGain=null;
function ensureAudio(){if(audioCtx)return;audioCtx=new(window.AudioContext||window.webkitAudioContext)();masterGain=audioCtx.createGain();masterGain.gain.value=.8;masterGain.connect(audioCtx.destination);}
function beep(f,d=.1){if(!audioCtx)return;const n=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(f,n);g.gain.setValueAtTime(.18,n);g.gain.exponentialRampToValueAtTime(0.0001,n+d*.9);o.connect(g).connect(masterGain);o.start(n);o.stop(n+d);}
const SFX={coin(){beep(1100,.07)},ruby(){beep(700,.1)},sapp(){beep(520,.1)},miss(){beep(240,.12)}};

/* æŒ‰éµ */
document.getElementById('btnHome').onclick=()=>location.href='index.html';
btnPause.onclick=()=>togglePause();
btnReplay.onclick=()=>restart();
btnFinish.onclick=()=>gotoEnd();

/* éŠæˆ²ä¸»é‚è¼¯ */
const items=[];let spawnTimer=0;
const TYPES={COIN:'coin',RUBY:'ruby',SAPP:'sapp'};
const SCORE_MAP={coin:10,ruby:50,sapp:100};
const SIZE_MAP={coin:28,ruby:30,sapp:34};

function spawn(dt){
  spawnTimer-=dt;
  if(spawnTimer<=0 && items.length<6){
    const r=Math.random();
    const type=r<0.6?'coin':r<0.82?'ruby':'sapp';
    items.push({type,x:Math.random()*canvas.clientWidth,y:-20,vy:2.5+Math.random()*2.2,rot:Math.random()*Math.PI*2,vrot:-0.14+Math.random()*0.28});
    spawnTimer=0.5+Math.random()*0.5;
  }
}

function start(){state=State.PLAYING;panelWin.classList.add('hidden');refreshHUD();}
function togglePause(){state=state===State.PLAYING?State.PAUSED:State.PLAYING;}
function restart(){score=carry;timeLeft=TOTAL_TIME_SEC;items.length=0;spawnTimer=0;chest.x=canvas.clientWidth/2;state=State.PLAYING;panelWin.classList.add('hidden');refreshHUD();}
function gotoEnd(){
  const s=Math.floor(score);
  best=Math.max(best,s);
  localStorage.setItem('neox_catch_best_l3',String(best));
  location.href=`endgame.html?score=${s}&best=${best}`;
}

/* è¿´åœˆ */
let last=performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt=Math.min(50,now-last)/16.6667;last=now;
  drawScene();

  if(state===State.PLAYING){
    timeLeft=Math.max(0,timeLeft-dt/60);
    if(timeLeft<=0){panelWin.classList.remove('hidden');return;}
    chest.vx=(keys.has('L')?-chest.speed:0)+(keys.has('R')?chest.speed:0)||chest.vx*0.9;
    chest.x=Math.max(chest.w/2,Math.min(canvas.clientWidth-chest.w/2,chest.x+chest.vx));
    spawn(dt);
    for(const it of items){it.y+=it.vy*dt;it.rot+=it.vrot*dt;}
    const mouth={cx:chest.x,cy:chest.y-chest.h*0.58,rx:chest.w*0.36,ry:chest.h*0.18};
    for(let i=items.length-1;i>=0;i--){
      const it=items[i];
      const ex=(it.x-mouth.cx)/mouth.rx,ey=(it.y-mouth.cy)/mouth.ry;
      if(ex*ex+ey*ey<=1){score+=SCORE_MAP[it.type];items.splice(i,1);SFX[it.type]();refreshHUD();}
      else if(it.y>canvas.clientHeight+30){score=Math.max(0,score-5);items.splice(i,1);SFX.miss();refreshHUD();}
    }
  }
}
requestAnimationFrame(loop);

function drawScene(){
  const w=canvas.clientWidth,h=canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  drawChest();drawItems();
}
function drawChest(){
  const{x,y,w,h}=chest;
  if(chestReady){ctx.drawImage(chestImg,x-w/2,y-h,w,h);}else{ctx.fillStyle='#1c274f';ctx.fillRect(x-w/2,y-h,w,h);}
}
function drawItems(){
  for(const it of items){
    const size=SIZE_MAP[it.type],r=size/2;
    ctx.save();ctx.translate(it.x,it.y);ctx.rotate(it.rot);
    let img=it.type==='coin'?coinImg:it.type==='ruby'?rubyImg:sappImg;
    let ready=it.type
        let ready=it.type==='coin'?coinReady:it.type==='ruby'?rubyReady:sappReady;
    if(ready){ctx.drawImage(img,-r,-r,size,size);}
    else{ctx.fillStyle='#ccc';ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.fill();}
    ctx.restore();
  }
}

/* ====== é–‹å ´å‹•ç•«æµç¨‹ ====== */
bgVideo.play().catch(()=>{});
let opActuallyPlayed=false,opCanEnd=false;
function showOpVideo(){opVideo.style.opacity='1';}
async function tryPlayOpMuted(){
  try{await opVideo.play();showOpVideo();}
  catch{opCtrl.style.visibility='visible';}
}
addEventListener('DOMContentLoaded',tryPlayOpMuted,{once:true});
['pointerdown','touchstart','click','keydown'].forEach(evt=>{
  window.addEventListener(evt,tryPlayOpMuted,{once:true,passive:true});
});
opVideo.addEventListener('timeupdate',()=>{if(opVideo.currentTime>0.25)opActuallyPlayed=true;});
setTimeout(()=>{opCanEnd=true;},600);
opVideo.addEventListener('ended',()=>endOpening(false));

function endOpening(userSkip){
  if(!opCanEnd&&!userSkip)return;
  if(!opActuallyPlayed&&!userSkip){opCtrl.style.visibility='visible';return;}
  opening.classList.add('fadeout');
  setTimeout(()=>{opening.style.display='none';start();},600);
}

/* ====== é–‹å ´æŒ‰éˆ• 5 ç§’æ·¡å‡º + Sound åˆ‡æ› ====== */
const overlay=opCtrl;
let overlayTimer=null;

function updateSoundBtn(){
  opSoundBtn.textContent=opVideo.muted?'ğŸ”ˆ Sound on':'ğŸ”‡ Sound off';
}

function showOverlayTemp(ms=5000){
  clearTimeout(overlayTimer);
  overlay.style.visibility='visible';
  overlay.classList.remove('hide');
  overlayTimer=setTimeout(()=>overlay.classList.add('hide'),ms);
}

opVideo.addEventListener('play',()=>{
  showOpVideo();
  updateSoundBtn();
  showOverlayTemp(5000);
});

['pointerdown','touchstart','mousemove','keydown','click'].forEach(evt=>{
  window.addEventListener(evt,()=>showOverlayTemp(5000),{passive:true});
});

opPlayBtn.onclick=async()=>{
  try{await opVideo.play();}catch{}
  showOverlayTemp(5000);
};

opSoundBtn.onclick=async()=>{
  try{
    opVideo.muted=!opVideo.muted;
    await opVideo.play();
    updateSoundBtn();
    showOverlayTemp(5000);
  }catch{}
};

opSkipBtn.onclick=()=>{
  overlay.classList.add('hide');
  endOpening(true);
};
</script>
</body>
</html>