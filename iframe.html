<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Game (iframe)</title>
<style>
  body{
    margin:0;background:#0a0b1f;color:#fff;height:100vh;display:grid;place-items:center;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;
  }
  iframe{
    width:min(92vw,440px); aspect-ratio:9/16; border:0; border-radius:16px;
    box-shadow:0 10px 40px rgba(0,0,0,.45);
  }
  .scorebox,.top3{
    position:fixed; left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.08); border-radius:10px; padding:8px 14px;
    font-weight:800; font-size:14px; box-shadow:0 4px 10px rgba(0,0,0,.3); backdrop-filter:blur(4px)
  }
  .top3{ top:10px; }
  .scorebox{ bottom:10px; }
  .top3 ol{ margin:6px 0 0; padding-left:18px }
  .top3 small{ opacity:.85; font-weight:600 }
</style>

<!-- üéÆ Ëµ∑ÈªûÔºöÊ≤øÁî®‰Ω†ÂéüÊú¨ÁöÑ index.html ÂÖ®ÊµÅÁ®ãÔºàÂãïÁï´‚Üív1‚Üí‚Ä¶‚ÜíendgameÔºâ -->
<iframe id="game" src="index.html" allow="gamepad *"></iframe>

<!-- üèÜ ÂÖ®ÁêÉ Top3ÔºàÈõ≤Á´ØÔºâ -->
<div class="top3">
  Top 3
  <ol id="top3List"><li>Loading‚Ä¶</li></ol>
  <small id="top3Hint"></small>
</div>

<!-- üìü Âç≥ÊôÇ/ÊúÄÂæåÂàÜÊï∏È°ØÁ§∫ÔºàÊú¨Âú∞Ôºâ -->
<div class="scorebox" id="scoreBox">Last Score: 0</div>

<script>
/* ====== Cloud API ====== */
const API_URL = 'https://script.google.com/macros/s/AKfycbw44w4f5hpmKiledO1XfIKsGgfMgCksmcU2Qsst56l68CPLvQs4GvIg0PrItIuUqkOT2g/exec';

/* ====== Êú¨Âú∞ÊúÄËøëÂàÜÊï∏Áõí ====== */
const APPKEY='neox_iframe_lastscore';
const box=document.getElementById('scoreBox');
const state=(()=>{try{return JSON.parse(localStorage.getItem(APPKEY)||'{}')}catch(_){return{}}})();
function save(){ localStorage.setItem(APPKEY, JSON.stringify(state)); }
function showLast(){ box.textContent='Last Score: ' + (state.last||0); }
showLast();

/* ====== Áé©ÂÆ∂ÂêçÁ®±ÔºàÂè™Âïè‰∏ÄÊ¨°Ôºâ ====== */
function getPlayerName(){
  let name = localStorage.getItem('nx_player_name');
  if(!name){
    name = prompt('Enter your name for Top 3:','Player') || 'Player';
    name = String(name).slice(0,20);
    localStorage.setItem('nx_player_name', name);
  }
  return name;
}

/* ====== ËÆÄÊ¶úÔºà‰Ω†ÁöÑ Apps ScriptÔºöGET ÂõûÂÇ≥Èô£ÂàóÔºâ ====== */
async function loadTop3(){
  const ul = document.getElementById('top3List');
  const hint = document.getElementById('top3Hint');
  try{
    const res = await fetch(API_URL);
    const data = await res.json();   // ‚Üê e.g. [{name,score,time}, ...]
    ul.innerHTML = '';
    (data||[]).slice(0,3).forEach((r)=>{
      const li = document.createElement('li');
      li.textContent = `${r.name} ‚Äî ${r.score}`;
      ul.appendChild(li);
    });
    if(!ul.children.length){ ul.innerHTML = '<li>No records</li>'; }
    hint.textContent = 'Updated: ' + new Date().toLocaleString();
  }catch(e){
    ul.innerHTML = '<li>Network error</li>'; hint.textContent='';
  }
}

/* ====== ‰∏äÂÇ≥ÂàÜÊï∏Ôºà‰Ω†ÁöÑ Apps ScriptÔºöPOST body = {name, score}Ôºâ ====== */
async function submitFinal(total){
  try{
    await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name:getPlayerName(), score: Math.floor(total) })
    });
  }catch(e){}
}

/* ====== Â≠êÈ†ÅÈÄöË®äÔºàÂãïÁï´/ÈóúÂç°/ÁµêÂ∞æÔºâ ======
   - {type:'NX_GOTO', next:'v1.html'}
   - {type:'NX_CARRY', score:1234}
   - {type:'NX_GAME_CLEARED', total:9999, next:'endgame.html'}
*/
const frame=document.getElementById('game');
window.addEventListener('message', async (e)=>{
  const m=e.data||{};
  if(m.type==='NX_GOTO' && m.next){ frame.src=m.next; }

  if(m.type==='NX_CARRY'){
    box.textContent='Score: ' + Math.floor(m.score||0);
  }

  if(m.type==='NX_GAME_CLEARED'){
    state.last = Math.floor(m.total || m.score || 0);
    save(); showLast();
    await submitFinal(state.last);   // ‰∏äÂÇ≥Èõ≤Á´Ø
    await loadTop3();                // Á´ãÂç≥Âà∑Êñ∞Ê¶ú
    if(m.next) frame.src = m.next;   // ‰æãÂ¶Ç endgame.html
  }
});

/* È¶ñÊ¨°ËºâÂÖ•Êäì‰∏ÄÊ¨°Ê¶ú */
loadTop3();
</script>
</html>