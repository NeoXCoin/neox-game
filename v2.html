<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Catch – Level 2</title>
<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;overflow:hidden;}
  #wrap{position:relative;height:100%;display:grid;place-items:center;}
  canvas{display:block;width:min(92vw,700px);aspect-ratio:9/16;height:auto;border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);touch-action:none;position:relative;z-index:2;}
  video.bg{
    position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;
    opacity:0.9;pointer-events:none;
  }
  video.intro{
    position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:10;
    background:#000;
  }
  .hud{
    position:absolute;inset:0;z-index:5;pointer-events:none;display:grid;grid-template-rows:auto 1fr;
  }
  .topbar{display:grid;grid-template-columns:1fr auto 1fr;align-items:start;gap:10px;padding:10px 14px;font-weight:800;}
  .center{justify-self:center;}
  .badge{display:inline-block;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.14);backdrop-filter:blur(3px);
         box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);margin:0 6px;font-weight:900;}
  .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:auto;
         text-align:center;padding:18px 16px 20px;border-radius:16px;background:rgba(10,12,34,.88);
         box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.08);backdrop-filter:blur(4px);z-index:15;}
  .panel h1{margin:8px 0 10px;font-size:clamp(22px,5.2vw,30px);}
  .btn{border:0;border-radius:12px;padding:10px 18px;font-weight:900;cursor:pointer;color:#fff;background:#2b7cff;
       box-shadow:0 8px 22px rgba(43,124,255,.35);margin-top:10px;}
  .hidden{display:none!important;}
</style>
</head>
<body>
<div id="wrap">
  <!-- 🌌 背景動畫 -->
  <video class="bg" src="https://neoxcoin.github.io/neox-game/CatchCoinL2BackGround%20.mp4" autoplay muted loop playsinline></video>

  <!-- 🪙 遊戲主畫面 -->
  <canvas id="game" width="450" height="800"></canvas>

  <!-- 🎬 開場動畫 -->
  <video id="introVideo" class="intro" src="https://neoxcoin.github.io/neox-game/CatchCoinL2.mp4" autoplay playsinline></video>
  
  <div class="panel hidden" id="panelStart">
    <h1>NeoX Catch — Level 2</h1>
    <p>Move the <b>Treasure Box</b> to catch <b>NeoX Coins</b>.<br>Special Genesis Coins give extra points!</p>
    <button class="btn" id="btnStart">▶ Start Game</button>
  </div>

  <div class="hud">
    <div class="topbar center">
      <span class="badge" id="scoreBadge">Score: 0</span>
      <span class="badge" id="timeBadge">Time: 03:00</span>
    </div>
  </div>
</div>

<script>
/* ====== Config ====== */
const TOTAL_TIME_SEC = 180;
const EDGE = 2;

/* ====== Assets ====== */
const BG_URL = "https://neoxcoin.github.io/neox-game/CatchCoinL2BackGround%20.mp4";
const CHEST_URL = "https://neoxcoin.github.io/neox-game/Treasure%20Box.png";
const COIN_URL = "https://neoxcoin.github.io/neox-emoji-128.png";
const BONUS_URL = "https://neoxcoin.github.io/neox-game/NeoCoin.png";

/* ====== Canvas ====== */
const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
function fitHiDPI(){
  const cssW=canvas.clientWidth,cssH=canvas.clientHeight;
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,2));
  if(canvas.width!==Math.round(cssW*dpr)){canvas.width=Math.round(cssW*dpr);canvas.height=Math.round(cssH*dpr);}
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
fitHiDPI();addEventListener('resize',fitHiDPI);

/* ====== State ====== */
let state=0;const State={PLAYING:1,WIN:2};
let score=0,timeLeft=TOTAL_TIME_SEC,coins=[],spawnTimer=0;

/* ====== HUD ====== */
const scoreBadge=document.getElementById('scoreBadge');
const timeBadge=document.getElementById('timeBadge');
function fmt(t){const m=Math.floor(t/60),s=Math.floor(t%60);return`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
function refreshHUD(){scoreBadge.textContent=`Score: ${Math.floor(score)}`;timeBadge.textContent=`Time: ${fmt(timeLeft)}`;}

/* ====== Images ====== */
const chestImg=new Image();chestImg.src=CHEST_URL;let chestReady=false;chestImg.onload=()=>chestReady=true;
const coinImg=new Image();coinImg.src=COIN_URL;let coinReady=false;coinImg.onload=()=>coinReady=true;
const bonusImg=new Image();bonusImg.src=BONUS_URL;let bonusReady=false;bonusImg.onload=()=>bonusReady=true;

/* ====== Chest ====== */
const chest={x:225,y:700,w:220,h:160,speed:6.2,vx:0};
function placeChest(){const H=canvas.clientHeight;chest.y=Math.max(chest.h,H-18);}
placeChest();

/* ====== Audio ====== */
let audioCtx=null,masterGain=null;
function ensureAudio(){if(audioCtx)return;audioCtx=new (window.AudioContext||window.webkitAudioContext)();masterGain=audioCtx.createGain();masterGain.connect(audioCtx.destination);}
async function resumeAudio(){try{ensureAudio();if(audioCtx.state!=='running')await audioCtx.resume();}catch(e){}}
function beep(f,d=.1){if(!audioCtx)return;const n=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();
o.type='sine';o.frequency.setValueAtTime(f,n);g.gain.setValueAtTime(.18,n);g.gain.exponentialRampToValueAtTime(0.0001,n+d*.9);
o.connect(g).connect(masterGain);o.start(n);o.stop(n+d);}
const SFX={star(){beep(880,.08);setTimeout(()=>beep(1320,.08),40)},bonus(){beep(700,.12);setTimeout(()=>beep(1000,.12),50)}};

/* ====== Coins ====== */
function spawnCoins(dt){
  spawnTimer-=dt;
  const maxOnScreen=5;
  if(spawnTimer<=0&&coins.length<maxOnScreen){
    const SAFE_MARGIN=chest.w*0.12;
    const xMin=EDGE+SAFE_MARGIN,xMax=canvas.clientWidth-(EDGE+SAFE_MARGIN);
    const isBonus=Math.random()<0.15;
    coins.push({
      x:xMin+Math.random()*(xMax-xMin),y:-20,
      r:isBonus?15:12,
      vy:(isBonus?3.2:2.6)+Math.random()*2.2,
      spin:Math.random()*Math.PI*2,vspin:-0.12+Math.random()*0.24,
      type:isBonus?'bonus':'normal',
      val:isBonus?30:10
    });
    spawnTimer=0.55+Math.random()*0.55;
  }
}

/* ====== Game Flow ====== */
function start(){
  score=Number(localStorage.getItem('nx_carry')||0);
  timeLeft=TOTAL_TIME_SEC;coins.length=0;spawnTimer=0;
  chest.x=canvas.clientWidth/2;chest.vx=0;state=State.PLAYING;
  document.getElementById('panelStart').classList.add('hidden');
  refreshHUD();
  resumeAudio();
}

/* ====== Loop ====== */
let last=performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt=Math.min(50,now-last)/16.6667;last=now;
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  if(state===State.PLAYING){
    timeLeft=Math.max(0,timeLeft-dt/60);
    if(timeLeft<=0){localStorage.setItem('nx_carry',String(Math.floor(score)));window.location.href='v3.html#continue';}
    chest.x=Math.max(chest.w/2+EDGE,Math.min(canvas.clientWidth-chest.w/2-EDGE,chest.x+chest.vx));
    spawnCoins(dt);
    for(const c of coins){c.y+=c.vy*dt;c.spin+=c.vspin*dt;}
    const mouth={cx:chest.x,cy:chest.y-chest.h*0.58,rx:chest.w*0.36,ry:chest.h*0.18};
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i];
      const ex=(c.x-mouth.cx)/mouth.rx,ey=(c.y-mouth.cy)/mouth.ry;
      if(ex*ex+ey*ey<=1){
        score+=c.val;
        c.type==='bonus'?SFX.bonus():SFX.star();
        coins.splice(i,1);refreshHUD();
      }else if(c.y>canvas.clientHeight+30)coins.splice(i,1);
    }
    refreshHUD();
  }
  drawChest();drawCoins();
}
requestAnimationFrame(loop);

/* ====== Render ====== */
function drawChest(){
  const{x,y,w,h}=chest;
  if(chestReady)ctx.drawImage(chestImg,x-w/2,y-h,w,h);
  else{ctx.fillStyle='#334';ctx.fillRect(x-w/2,y-h,w,h);}
}
function drawCoins(){
  for(const c of coins){
    const size=c.r*3,r=size/2;
    ctx.save();ctx.translate(c.x,c.y);ctx.rotate(c.spin);
    if(c.type==='bonus'&&bonusReady){
      const g=ctx.createRadialGradient(0,0,r*0.4,0,0,r*1.6);
      g.addColorStop(0,'rgba(255,230,120,0.8)');
      g.addColorStop(1,'rgba(255,180,0,0)');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,r*1.5,0,Math.PI*2);ctx.fill();
      ctx.drawImage(bonusImg,-r,-r,size,size);
    }else if(coinReady){
      ctx.drawImage(coinImg,-r,-r,size,size);
    }
    ctx.restore();
  }
}

/* ====== Input ====== */
let pointerId=null;
canvas.addEventListener('pointerdown',e=>{
  pointerId='mouse';
  if(state!==State.PLAYING)start();
  resumeAudio();
});
addEventListener('pointermove',e=>{
  if(pointerId){
    const rect=canvas.getBoundingClientRect();
    const cx=(e.clientX-rect.left)/rect.width*canvas.clientWidth;
    const diff=cx-chest.x;
    chest.vx=Math.max(-chest.speed,Math.min(chest.speed,diff*0.25));
  }
});
addEventListener('pointerup',()=>{pointerId=null;chest.vx=0;});
</script>

<script>
// === 開場動畫控制 ===
const intro=document.getElementById('introVideo');
const startPanel=document.getElementById('panelStart');
intro.onended=()=>{intro.classList.add('hidden');startPanel.classList.remove('hidden');};
</script>
</body>
</html>