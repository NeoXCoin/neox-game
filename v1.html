<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Catch ‚Äì Level 1</title>
<style>
  html,body{height:100%;margin:0;background:#0a0b1f;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;overflow:hidden}
  #wrap{position:relative;height:100%;display:grid;place-items:center}
  canvas{display:block;width:min(92vw,820px);aspect-ratio:9/16;height:auto;border-radius:16px;background:#000;box-shadow:0 20px 60px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.06);touch-action:none}

  .hud{position:absolute;inset:0;display:grid;grid-template-rows:auto 1fr auto;pointer-events:none}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .pill{padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.12);backdrop-filter:blur(4px);font-weight:800}
  .badges{display:flex;gap:10px;pointer-events:none}
  /* ÁΩÆ‰∏≠ÔºàÊ°åÈù¢ÔºâÔºõÊâãÊ©üÂ∞±Èù†Â∑¶È°ØÁ§∫ */
  @media (min-width:821px){
    .topbar{justify-content:center}
    .badges{position:relative}
  }

  /* Â∑¶ÔºöHomeÔºàX logoÔºâ / Âè≥ÔºöPause */
  .corner{pointer-events:auto;position:absolute;top:10px}
  .corner.left{left:12px}
  .corner.right{right:12px}
  .btn{display:flex;align-items:center;gap:8px;border:0;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer;color:#fff;background:rgba(28,39,79,.9);box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .btn img{width:22px;height:22px;display:block}
  .btn.alt{background:rgba(31,38,72,.9)}

  .center{display:grid;place-items:center;padding:10px}
  .panel{pointer-events:auto;min-width:clamp(240px,80%,520px);text-align:center;padding:18px 16px 20px;border-radius:14px;background:rgba(10,12,34,.86);box-shadow:0 20px 60px rgba(0,0,0,.5),inset 0 0 0 1px rgba(255,255,255,.06);backdrop-filter:blur(4px)}
  .panel h1{margin:8px 0 6px;font-size:clamp(20px,4.8vw,28px)}
  .panel p{margin:6px 0 14px;color:#b9c1ff;font-size:14px;line-height:1.5}
  .row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
  .action{pointer-events:auto;border:0;border-radius:12px;padding:10px 14px;font-weight:800;background:#2b7cff;color:#fff;box-shadow:0 6px 18px rgba(43,124,255,.35);cursor:pointer}
  .action.alt{background:#1f2648;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
  .hidden{display:none!important}

  .level-banner{position:absolute;left:50%;top:60px;transform:translateX(-50%);background:rgba(255,255,255,.12);border-radius:999px;padding:8px 14px;font-weight:900;letter-spacing:.3px;pointer-events:none}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="450" height="800" aria-label="NeoX Catch Level 1"></canvas>

  <div class="hud" aria-live="polite">
    <!-- Â∑¶‰∏ä HomeÔºàXÔºâ -->
    <div class="corner left">
      <button id="btnHome" class="btn">
        <img id="homeLogo" alt="Home" />
        <span>Home</span>
      </button>
    </div>

    <!-- Âè≥‰∏ä Pause / Resume -->
    <div class="corner right">
      <button id="btnPause" class="btn alt">‚è∏ Pause</button>
    </div>

    <!-- ÁΩÆ‰∏≠ÁöÑ Score / Best -->
    <div class="topbar">
      <div class="badges">
        <div class="pill" id="scoreBadge">Score: 0</div>
        <div class="pill" id="bestBadge">Best: 0</div>
      </div>
    </div>

    <div class="center">
      <div id="panelStart" class="panel">
        <h1>NeoX Catch ‚Äì Level 1</h1>
        <p>Move the <b>Treasure Box</b> at the bottom to catch falling <b>NeoX Coins</b>.<br>
           Keyboard <b>‚Üê ‚Üí</b> or tap/drag left & right.</p>
        <div class="row"><button id="btnStart" class="action">‚ñ∂ Start</button></div>
      </div>

      <div id="panelPause" class="panel hidden">
        <h1>Paused</h1>
        <div class="row">
          <button id="btnResume" class="action">‚èµ Resume</button>
          <button id="btnRestart2" class="action alt">üîÑ Replay</button>
        </div>
      </div>

      <div id="panelWin" class="panel hidden">
        <h1>Level 1 Clear!</h1>
        <p><span id="finalScore">Score: 0</span><br><span id="bestScore">Best: 0</span></p>
        <div class="row">
          <button id="btnNextLevel" class="action">Go to Level 2 ‚ñ∂</button>
          <button id="btnPlayAgain" class="action alt">Replay</button>
        </div>
      </div>
    </div>

    <div class="level-banner hidden" id="levelBanner">LEVEL 1</div>
  </div>
</div>

<script>
/* ====== Assets ====== */
const BG_URL   = "https://neoxcoin.github.io/neox-game/forest%20background%20.PNG";
const CHEST_URL= "https://neoxcoin.github.io/neox-game/treasure-box.png";  // Âª∫Ë≠∞ÂÖ®Â∞èÂØ´Ë∑ØÂæë
const COIN_URL = "https://neoxcoin.github.io/neox-emoji-128.png";
const HOME_URL = "https://neoxcoin.github.io/neox-game/XNXC.png";

/* ====== HiDPI ====== */
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
function fitHiDPI(){
  const cssW=canvas.clientWidth, cssH=canvas.clientHeight;
  const dpr=Math.max(1,Math.min(devicePixelRatio||1,2));
  if(canvas.width!==Math.round(cssW*dpr)){ canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr); }
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
fitHiDPI(); addEventListener('resize',fitHiDPI);

/* ====== State ====== */
const State={READY:0,PLAYING:1,PAUSED:2,WIN:3};
let state=State.READY;

/* ====== DOM ====== */
const scoreBadge=document.getElementById('scoreBadge');
const bestBadge=document.getElementById('bestBadge');
const panelStart=document.getElementById('panelStart');
const panelPause=document.getElementById('panelPause');
const panelWin=document.getElementById('panelWin');
const finalScore=document.getElementById('finalScore');
const bestScoreEl=document.getElementById('bestScore');
const levelBanner=document.getElementById('levelBanner');
document.getElementById('homeLogo').src=HOME_URL;

/* ====== Images ====== */
const bgImg=new Image(); bgImg.src=BG_URL; let bgReady=false; bgImg.onload=()=>bgReady=true;
const chestImg=new Image(); chestImg.src=CHEST_URL; let chestReady=false; chestImg.onload=()=>chestReady=true;
const coinImg=new Image(); coinImg.src=COIN_URL; let coinReady=false; coinImg.onload=()=>coinReady=true;

/* ====== Player (chest) ====== */
const chest={x:225,y:0,w:220,h:160,speed:6.2,vx:0};
function isMobile(){ return /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent); }

function placeChest(){
  const H = canvas.clientHeight;
  const land = matchMedia('(orientation: landscape)').matches;

  // Â∫ïÈÇäË∑ùÔºöÊâãÊ©üÂõ∫ÂÆö 18pxÔºõÊ°åÈù¢Áõ¥Âêë 3.5% (>=24px)ÔºõÊ©´Âêë 5% (>=24px)
  const bottomMargin = isMobile()
    ? 18
    : (land ? Math.max(24, H*0.05) : Math.max(24, H*0.035));

  // ÂØ∂ÁÆ±Â∞∫ÂØ∏ÔºàÁ®çÁ¥∞Ôºâ
  const targetW = Math.min(canvas.clientWidth * (isMobile()? 0.34 : 0.30), 280);
  chest.w = targetW;
  chest.h = Math.round(targetW * 0.72);

  // Y Ë≤ºËøëÂ∫ïÈÉ®
  chest.y = Math.max(chest.h, H - bottomMargin);

  // X ÈÇäÁïåÁïô 2pxÔºàÂ∑¶Âè≥ coin ‰πüÊé•Âà∞Ôºâ
  const margin = 2;
  chest.x = Math.max(
    chest.w/2 + margin,
    Math.min(chest.x || canvas.clientWidth/2, canvas.clientWidth - chest.w/2 - margin)
  );
}
placeChest(); addEventListener('resize',placeChest,{passive:true}); addEventListener('orientationchange',placeChest);

/* ====== Levels ====== */
const LEVELS=[
  { target:10,  vy:[2.0,2.8],  spawn:[0.9,1.2],  concurrent:2, mult:1.0 },
  { target:25,  vy:[2.6,3.4],  spawn:[0.7,1.0],  concurrent:3, mult:1.2 },
  { target:45,  vy:[3.0,3.8],  spawn:[0.55,0.85],concurrent:4, mult:1.4 },
  { target:70,  vy:[3.6,4.6],  spawn:[0.45,0.75],concurrent:5, mult:1.7 },
  { target:100, vy:[4.2,5.4],  spawn:[0.36,0.66],concurrent:6, mult:2.1 },
];
let levelIdx=0, caughtThisLevel=0;

/* ====== Score ====== */
let score=0, best=Number(localStorage.getItem('neox_catch_best')||0);

/* ====== Audio ====== */
let audioCtx=null, masterGain=null, soundOn=true;
function ensureAudio(){ if(audioCtx) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); masterGain.gain.value=0.8; masterGain.connect(audioCtx.destination); }
async function resumeAudio(){ try{ ensureAudio(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch{} }
function beep({freq=440,dur=0.12,type='sine',gain=0.2,decay=0.02,start=0}){ if(!soundOn||!audioCtx) return; const now=audioCtx.currentTime+start; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,now); g.gain.setValueAtTime(gain,now); g.gain.exponentialRampToValueAtTime(0.0001, now+Math.max(0.01,dur-decay)); o.connect(g).connect(masterGain); o.start(now); o.stop(now+dur); }
const SFX={ click(){beep({freq:700,dur:0.07,type:'triangle',gain:0.12});}, star(){beep({freq:880,dur:0.08,gain:0.18});beep({freq:1320,dur:0.10,gain:0.12,start:0.04});}, level(){[500,750,1100].forEach((f,i)=>beep({freq:f,type:'square',dur:0.10+0.02*i,gain:0.15,start:i*0.08}));}, win(){[660,880,990,1320].forEach((f,i)=>beep({freq:f,dur:0.14,gain:0.14,start:i*0.09}));} };

/* ====== UI / Buttons ====== */
function show(el,s=true){ el.classList.toggle('hidden',!s); }
function flashLevelBanner(text){ levelBanner.textContent=text; show(levelBanner,true); setTimeout(()=>show(levelBanner,false),1100); }
function refreshHUD(){
  scoreBadge.textContent = `Score: ${Math.floor(score)}`;
  bestBadge.textContent  = `Best: ${Math.floor(best)}`;
  finalScore.textContent = `Score: ${Math.floor(score)}`;
  bestScoreEl.textContent= `Best: ${Math.floor(best)}`;
}

document.getElementById('btnHome').onclick=()=>{ location.href='index.html'; };
document.getElementById('btnStart').onclick=()=>{ SFX.click(); start(); };
document.getElementById('btnRestart2').onclick=()=>{ SFX.click(); restart(); };
document.getElementById('btnPlayAgain').onclick=()=>{ SFX.click(); restart(); };
document.getElementById('btnResume').onclick=()=>{ SFX.click(); togglePause(false); };
document.getElementById('btnPause').onclick=()=>{ SFX.click(); togglePause(); };
document.getElementById('btnNextLevel').onclick=()=>{ location.href='v2.html'; };

/* ====== Input ====== */
const keys=new Set();
addEventListener('keydown',e=>{
  if(e.repeat) return;
  if(e.key==='ArrowLeft') keys.add('L');
  if(e.key==='ArrowRight') keys.add('R');
  if(e.key.toLowerCase()==='p') togglePause();
  if(e.key.toLowerCase()==='r') restart();
  if(state===State.READY && (e.key===' '||e.key==='Enter')) start();
});
addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft') keys.delete('L');
  if(e.key==='ArrowRight') keys.delete('R');
});
let pointerId=null;
function onPointerDown(e){ const p=(e.changedTouches&&e.changedTouches[0])||e; pointerId=p.identifier??'mouse'; if(state===State.READY) start(); e.preventDefault(); }
function onPointerMove(e){
  const p=(e.changedTouches && ([...e.changedTouches].find(t => (t.identifier ?? 'mouse')===pointerId)))||e;
  if(!p) return;
  const rect=canvas.getBoundingClientRect();
  const cx=(p.clientX-rect.left)/rect.width*canvas.clientWidth;
  const diff=cx-chest.x; chest.vx=Math.max(-chest.speed, Math.min(chest.speed, diff*0.25));
  e.preventDefault();
}
function onPointerUp(e){ pointerId=null; chest.vx=0; e.preventDefault(); }
canvas.addEventListener('pointerdown',onPointerDown,{passive:false});
addEventListener('pointermove',onPointerMove,{passive:false});
addEventListener('pointerup',onPointerUp,{passive:false});
addEventListener('pointercancel',onPointerUp,{passive:false});
['pointerdown','keydown'].forEach(evt=>window.addEventListener(evt,resumeAudio,{once:true,passive:true}));
addEventListener('blur',()=>{ if(state===State.PLAYING) togglePause(true); });

/* ====== Flow ====== */
let spawnTimer=0;
const coins=[];
function start(){
  score=0; levelIdx=0; caughtThisLevel=0; coins.length=0; spawnTimer=0;
  placeChest(); chest.vx=0;
  state=State.PLAYING; show(panelStart,false); show(panelPause,false); show(panelWin,false);
  flashLevelBanner('LEVEL 1'); refreshHUD();
}
function togglePause(forcePause){
  const btn=document.getElementById('btnPause');
  if(state===State.PLAYING && (forcePause??true)){
    state=State.PAUSED; show(panelPause,true); btn.textContent='‚èµ Resume';
  }else if(state===State.PAUSED){
    state=State.PLAYING; show(panelPause,false); btn.textContent='‚è∏ Pause';
  }
}
function restart(){ show(panelPause,false); show(panelWin,false); start(); }
function win(){
  state=State.WIN; best=Math.max(best,Math.floor(score));
  localStorage.setItem('neox_catch_best',String(best));
  refreshHUD(); SFX.win(); show(panelWin,true);
}

/* ====== Coins ====== */
function rand(a,b){ return Math.random()*(b-a)+a; }
function spawnCoins(dt){
  const L=LEVELS[levelIdx]; spawnTimer-=dt;
  if(spawnTimer<=0 && coins.length<L.concurrent){
    const EDGE=2, r=12;
    const minX=EDGE+r, maxX=canvas.clientWidth-EDGE-r;  // Ë¶ÜËìãÂ∑¶Âè≥ÈÇäÁ∑£
    coins.push({ x:rand(minX,maxX), y:-20, r, vy:rand(L.vy[0],L.vy[1]), spin:rand(0,Math.PI*2), vspin:rand(-0.12,0.12) });
    spawnTimer=rand(L.spawn[0],L.spawn[1]);
  }
}

/* ====== Loop ====== */
let last=performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt=Math.min(50,now-last)/16.6667; last=now;

  drawBackground();

  if(state===State.PLAYING){
    chest.vx=(keys.has('L')?-chest.speed:0)+(keys.has('R')?chest.speed:0) || chest.vx*0.92;
    const margin=2;
    chest.x=Math.max(chest.w/2+margin, Math.min(chest.x+chest.vx, canvas.clientWidth-chest.w/2-margin));

    spawnCoins(dt);
    for(const c of coins){ c.y+=c.vy*dt; c.spin+=c.vspin*dt; }

    // Ê©¢ÂúìÂΩ¢„ÄåÁÆ±Âè£„ÄçÁ¢∞Êíû
    const mouth={ cx:chest.x, cy:chest.y - chest.h*0.58, rx:chest.w*0.34, ry:chest.h*0.16 };
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i];
      const ex=(c.x-mouth.cx)/mouth.rx, ey=(c.y-mouth.cy)/mouth.ry;
      if(ex*ex+ey*ey<=1){
        score+=Math.round(10*LEVELS[levelIdx].mult); caughtThisLevel++; coins.splice(i,1); SFX.star();
        if(caughtThisLevel>=LEVELS[levelIdx].target){
          if(levelIdx<LEVELS.length-1){ levelIdx++; caughtThisLevel=0; flashLevelBanner(`LEVEL ${levelIdx+1}`); SFX.level(); }
          else { win(); }
        }
        refreshHUD();
      }else if(c.y>canvas.clientHeight+30){ coins.splice(i,1); }
    }
  }

  drawChest(); drawCoins();

  if(state===State.READY){
    ctx.font='600 18px system-ui,-apple-system,"Segoe UI"';
    ctx.textAlign='center'; ctx.fillStyle='rgba(255,255,255,.9)';
    ctx.fillText('Tap or press Space to start', canvas.clientWidth/2, canvas.clientHeight*0.62);
  }
}
requestAnimationFrame(loop);

/* ====== Drawing ====== */
function drawBackground(){
  const w=canvas.clientWidth,h=canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  if(!bgReady){ const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,"#0f1240"); g.addColorStop(1,"#0a0c22"); ctx.fillStyle=g; ctx.fillRect(0,0,w,h); return; }
  const iw=bgImg.width, ih=bgImg.height, ir=iw/ih, cr=w/h; let dw,dh,dx,dy;
  if(ir>cr){ dh=h; dw=h*ir; dx=(w-dw)/2; dy=0; } else { dw=w; dh=w/ir; dx=0; dy=(h-dh)/2; }
  ctx.drawImage(bgImg,dx,dy,dw,dh);
}
function drawChest(){
  const {x,y,w,h}=chest;
  const grad=ctx.createRadialGradient(x,y-24,6,x,y-24,120);
  grad.addColorStop(0,'rgba(43,124,255,0.30)'); grad.addColorStop(1,'rgba(43,124,255,0)');
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(x,y-24,90,0,Math.PI*2); ctx.fill();
  if(chestReady){ ctx.save(); ctx.shadowColor='rgba(0,0,0,0.35)'; ctx.shadowBlur=18; ctx.drawImage(chestImg, x-w/2, y-h, w, h); ctx.restore(); }
  else { ctx.fillStyle='#1c274f'; ctx.fillRect(x-w/2,y-h,w,h); }
}
function drawCoins(){ for(const c of coins){ drawCoin(c.x,c.y,c.r*3,c.spin); } }
function drawCoin(x,y,size,rot){
  const r=size/2; ctx.save(); ctx.translate(x,y); ctx.rotate(rot);
  if(coinReady){ ctx.save(); ctx.shadowColor='rgba(255,223,128,0.8)'; ctx.shadowBlur=18; ctx.drawImage(coinImg,-r,-r,size,size); ctx.restore(); }
  else{ const g=ctx.createRadialGradient(0,0,r*0.2,0,0,r); g.addColorStop(0,'#fff6cc'); g.addColorStop(1,'#e3b23c'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#402f00'; ctx.font=`${r*1.2}px Arial Black`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('N',0,2); }
  ctx.restore();
}
</script>
</body>
</html>