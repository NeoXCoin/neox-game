<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Catch ‚Äì Level 1</title>
<style>
  html, body{
    height:100%; margin:0; background:#0a0b1f; color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;
    overflow:hidden;
  }
  #wrap{ position:relative; height:100%; display:grid; place-items:center; }
  canvas{
    display:block; width:min(92vw, 820px); aspect-ratio:9/16; height:auto;
    border-radius:16px; background:#000;
    box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
    touch-action:none;
  }

  /* HUD */
  .hud{ position:absolute; inset:0; pointer-events:none; }
  .topbar{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:start;
    gap:10px; padding:10px 14px; font-weight:800;
  }
  .left{ justify-self:start; pointer-events:auto; }
  .center{ justify-self:center; pointer-events:none; }
  .right{ justify-self:end; pointer-events:auto; }
  .badge{
    display:inline-block; padding:8px 12px; border-radius:12px;
    background:rgba(255,255,255,.14); backdrop-filter:blur(3px);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
    margin:0 6px; font-weight:900;
  }
  .hidden{ display:none !important; }

  /* Home(X) Ëàá Pause */
  .iconbtn{
    display:inline-flex; align-items:center; gap:10px;
    background:#1b2144; border:0; color:#fff; border-radius:14px;
    padding:10px 14px; font-weight:800;
    box-shadow:0 10px 28px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.08);
    cursor:pointer; pointer-events:auto;
  }
  .iconbtn img{ width:22px; height:22px; object-fit:contain; display:block; }
  .iconbtn.small{ padding:10px 12px }

  /* ‰∏≠Â§ÆÈù¢Êùø */
  .panel{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    pointer-events:auto; min-width:clamp(240px,80%,520px); text-align:center;
    padding:18px 16px 20px; border-radius:16px; background:rgba(10,12,34,.88);
    box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.08);
    backdrop-filter:blur(4px);
  }
  .panel h1{ margin:8px 0 10px; font-size:clamp(22px,5.2vw,30px); }
  .panel p{ margin:0 0 14px; color:#c8d2ff; font-size:14px; line-height:1.55; }
  .row{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
  .btn{
    border:0; border-radius:12px; padding:10px 14px; font-weight:900; cursor:pointer; color:#fff; background:#2b7cff;
    box-shadow:0 8px 22px rgba(43,124,255,.35);
  }
  .btn.alt{ background:#1f2648; box-shadow: inset 0 0 0 1px rgba(255,255,255,.1); }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="450" height="800" aria-label="NeoX Catch Level 1"></canvas>

  <div class="hud" aria-live="polite">
    <div class="topbar">
      <div class="left">
        <button id="btnHome" class="iconbtn">
          <img src="https://neoxcoin.github.io/neox-game/XNXC.png" alt="Home">Home
        </button>
      </div>

      <!-- ÁΩÆ‰∏≠Âè™‰øùÁïô Score / Time / Best -->
      <div class="center">
        <span class="badge" id="scoreBadge">Score: 0</span>
        <span class="badge" id="timerBadge">Time: 05:00</span>
        <span class="badge" id="bestBadge">Best: 0</span>
      </div>

      <div class="right">
        <button id="btnPause" class="iconbtn small">‚è∏ Pause</button>
      </div>
    </div>

    <!-- Panels -->
    <div id="panelStart" class="panel">
      <h1>NeoX Catch ‚Äî Level 1</h1>
      <p>Move the <b>Treasure Box</b> to catch falling <b>NeoX Coins</b>. Reach the target to level up.<br>
         Keyboard <b>‚Üê ‚Üí</b> or drag left & right.</p>
      <div class="row"><button id="btnStart" class="btn">‚ñ∂ Start</button></div>
    </div>

    <div id="panelPause" class="panel hidden">
      <h1>Paused</h1>
      <div class="row">
        <button id="btnResume" class="btn">‚èµ Resume</button>
        <button id="btnRestart2" class="btn alt">üîÑ Restart</button>
      </div>
    </div>

    <div id="panelWin" class="panel hidden">
      <h1>All 5 Levels Clear! üéâ</h1>
      <p><span id="finalScore">Score: 0</span> ¬∑ <span id="bestScore">Best: 0</span></p>
      <div class="row">
        <button id="btnNextLevel" class="btn">Go to Level 2 ‚ñ∂</button>
        <button id="btnReplay" class="btn alt">Replay</button>
      </div>
    </div>

    <div id="panelTimeup" class="panel hidden">
      <h1>Time‚Äôs up ‚è±Ô∏è</h1>
      <p><span id="finalScore2">Score: 0</span> ¬∑ <span id="bestScore2">Best: 0</span></p>
      <div class="row">
        <button id="btnReplay2" class="btn alt">Replay</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== Assets ========== */
const BG_URL    = "https://neoxcoin.github.io/neox-game/forest%20background%20.PNG";
const CHEST_URL = "https://neoxcoin.github.io/neox-game/treasure-box.png";
const COIN_URL  = "https://neoxcoin.github.io/neox-emoji-128.png";

/* ========== HiDPI Canvas ========== */
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
function fitHiDPI(){
  const cssW=canvas.clientWidth, cssH=canvas.clientHeight;
  const dpr=Math.max(1, Math.min(devicePixelRatio||1, 2));
  if(canvas.width!==Math.round(cssW*dpr)){ canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr); }
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
fitHiDPI(); addEventListener('resize', fitHiDPI);

/* ========== State / HUD ========== */
const State={READY:0,PLAYING:1,PAUSED:2,WIN:3};
let state=State.READY;

const scoreBadge=document.getElementById('scoreBadge');
const timerBadge=document.getElementById('timerBadge');
const bestBadge =document.getElementById('bestBadge');
const panelStart=document.getElementById('panelStart');
const panelPause=document.getElementById('panelPause');
const panelWin  =document.getElementById('panelWin');
const panelTimeup=document.getElementById('panelTimeup');
const finalScore=document.getElementById('finalScore');
const bestScore =document.getElementById('bestScore');
const finalScore2=document.getElementById('finalScore2');
const bestScore2 =document.getElementById('bestScore2');

/* ========== Images ========== */
const bgImg=new Image(); bgImg.src=BG_URL; let bgReady=false; bgImg.onload=()=>bgReady=true;
const chestImg=new Image(); chestImg.src=CHEST_URL; let chestReady=false; chestImg.onload=()=>chestReady=true;
const coinImg=new Image(); coinImg.src=COIN_URL; let coinReady=false; coinImg.onload=()=>coinReady=true;

/* ========== Player (chest) Ëá™ÂãïË≤ºÂ∫ïÔºãÂ∞∫ÂØ∏ ========== */
const chest={x:225,y:0,w:220,h:160,speed:6.2,vx:0};
function isMobile(){ return /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent); }
function placeChest(){
  // Ë¶ñÁ™óÈ´òÂ∫¶
  const H = canvas.clientHeight;
  // Â∫ïÈÇäË∑ùÔºöÊâãÊ©üÂõ∫ÂÆö 18pxÔºõÊ°åÈù¢Áõ¥Âêë ‚âà3.5%ÔºåÊ©´Âêë ‚âà5%ÔºåÁöÜ >=24px
  const land = matchMedia('(orientation: landscape)').matches;
  const bottomMargin = isMobile() ? 18 : (land ? Math.max(24, H*0.05) : Math.max(24, H*0.035));

  // ÂØ∂ÁÆ±Â∞∫ÂØ∏ÔºàÁ∏ÆÁ¥∞Â∞ëÂ∞ëÔºâ
  const targetW = Math.min(canvas.clientWidth * (isMobile()?0.30:0.28), 260);
  chest.w = targetW;
  chest.h = Math.round(targetW * 0.72);

  // YÔºöË≤ºËøëÂ∫ïÈÉ®
  chest.y = Math.max(chest.h, H - bottomMargin);

  // XÔºöÂ∑¶Âè≥Áïô 2px ÈÇäË∑ùÔºå‰øùË≠âÂÖ©ÈÇä coin ÈÉΩÊé•Âà∞
  const margin = 2;
  chest.x = Math.max(chest.w/2 + margin,
             Math.min(chest.x || canvas.clientWidth/2, canvas.clientWidth - chest.w/2 - margin));
}
placeChest(); addEventListener('resize', placeChest); addEventListener('orientationchange', placeChest);

/* ========== Levels / Score / Timer ========== */
const LEVELS=[
  { target:10,  vy:[2.0,2.8],  spawn:[0.9,1.2],  concurrent:2, mult:1.0 },
  { target:25,  vy:[2.6,3.4],  spawn:[0.7,1.0],  concurrent:3, mult:1.2 },
  { target:45,  vy:[3.0,3.8],  spawn:[0.55,0.85],concurrent:4, mult:1.4 },
  { target:70,  vy:[3.6,4.6],  spawn:[0.45,0.75],concurrent:5, mult:1.7 },
  { target:100, vy:[4.2,5.4],  spawn:[0.36,0.66],concurrent:6, mult:2.1 }
];
let levelIdx=0, caughtThisLevel=0;
let score=0, best=Number(localStorage.getItem('neox_catch_best')||0);

// ÂÄíÊï∏Ôºà5 ÂàÜÈêòÔºâ
const START_SECONDS = 300; // ‚Üê ÊÉ≥ÊîπÊôÇÈñìÔºåÊîπÂë¢Â∫¶ÔºàÁßíÔºâ
let timeLeft = START_SECONDS;
let lastTick = performance.now();

// Â∏∂ÂàÜÊï∏Âéª v2
const CARRY_KEY = 'neox_score_carry';

/* ========== Audio (beeps) ========== */
let audioCtx=null, masterGain=null, soundOn=true;
function ensureAudio(){ if(audioCtx) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain(); masterGain.gain.value=.8; masterGain.connect(audioCtx.destination); }
async function resumeAudio(){ try{ ensureAudio(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){} }
function beep({f=440,d=.12,t='sine',g=.2,decay=.02,start=0}){ if(!soundOn||!audioCtx) return;
  const n=audioCtx.currentTime+start; const o=audioCtx.createOscillator(), ga=audioCtx.createGain();
  o.type=t; o.frequency.setValueAtTime(f,n); ga.gain.setValueAtTime(g,n);
  ga.gain.exponentialRampToValueAtTime(0.0001, n+Math.max(0.01,d-decay)); o.connect(ga).connect(masterGain); o.start(n); o.stop(n+d); }
const SFX={ click(){beep({f:700,d:.07,t:'triangle',g:.12});},
  star(){beep({f:880,d:.08,g:.18});beep({f:1320,d:.10,g:.12,start:.04});},
  level(){[500,750,1100].forEach((f,i)=>beep({f,t:'square',d:.10+.02*i,g:.15,start:i*.08}))},
  win(){[660,880,990,1320].forEach((f,i)=>beep({f,d:.14,g:.14,start:i*.09}))}
};

/* ========== UI helpers ========== */
function show(el, s=true){ el.classList.toggle('hidden', !s); }
function pad(n){ return String(n).padStart(2,'0'); }
function refreshHUD(){
  scoreBadge.textContent=`Score: ${Math.floor(score)}`;
  bestBadge.textContent =`Best: ${Math.floor(best)}`;
  finalScore.textContent=`Score: ${Math.floor(score)}`;
  bestScore.textContent =`Best: ${Math.floor(best)}`;
  finalScore2.textContent=`Score: ${Math.floor(score)}`;
  bestScore2.textContent =`Best: ${Math.floor(best)}`;
  const m=Math.floor(timeLeft/60), s=Math.floor(timeLeft%60);
  timerBadge.textContent=`Time: ${pad(m)}:${pad(s)}`;
}

/* ========== Buttons ========== */
document.getElementById('btnStart').onclick=()=>{SFX.click();start();};
document.getElementById('btnHome').onclick =()=>{window.location.href='index.html';};
document.getElementById('btnRestart2').onclick=()=>{SFX.click();restart();};
document.getElementById('btnReplay').onclick  =()=>{SFX.click();restart();};
document.getElementById('btnReplay2').onclick =()=>{SFX.click();restart();};
document.getElementById('btnNextLevel').onclick =()=>{localStorage.setItem(CARRY_KEY, String(Math.floor(score))); window.location.href='v2.html';};

const btnPause=document.getElementById('btnPause');
btnPause.onclick=()=>{SFX.click();togglePause();};
document.getElementById('btnResume').onclick=()=>{SFX.click();togglePause(false);};

/* ========== Input ========== */
const keys=new Set();
addEventListener('keydown', e=>{
  if(e.repeat) return;
  if(e.key==='ArrowLeft') keys.add('L');
  if(e.key==='ArrowRight') keys.add('R');
  if(e.key.toLowerCase()==='p') togglePause();
  if(e.key.toLowerCase()==='r') restart();
  if(state===State.READY && (e.key===' '||e.key==='Enter')) start();
});
addEventListener('keyup', e=>{ if(e.key==='ArrowLeft') keys.delete('L'); if(e.key==='ArrowRight') keys.delete('R'); });

let pointerId=null;
function onPointerDown(e){ const p=(e.changedTouches&&e.changedTouches[0])||e; pointerId=p.identifier??'mouse';
  if(state===State.READY) start(); e.preventDefault(); }
function onPointerMove(e){
  const p=(e.changedTouches && ([...e.changedTouches].find(t => (t.identifier ?? 'mouse')===pointerId)))||e; if(!p) return;
  const rect=canvas.getBoundingClientRect(); const cx=(p.clientX-rect.left)/rect.width*canvas.clientWidth;
  const diff=cx-chest.x; chest.vx=Math.max(-chest.speed, Math.min(chest.speed, diff*0.25)); e.preventDefault();
}
function onPointerUp(e){ pointerId=null; chest.vx=0; e.preventDefault(); }
canvas.addEventListener('pointerdown', onPointerDown, {passive:false});
addEventListener('pointermove', onPointerMove, {passive:false});
addEventListener('pointerup', onPointerUp, {passive:false});
addEventListener('pointercancel', onPointerUp, {passive:false});
['pointerdown','keydown'].forEach(evt=>window.addEventListener(evt, resumeAudio, {once:true, passive:true}));
addEventListener('blur', ()=>{ if(state===State.PLAYING) togglePause(true); });

/* ========== Flow ========== */
const coins=[]; let spawnTimer=0;
function start(){
  score=0; levelIdx=0; caughtThisLevel=0; coins.length=0; spawnTimer=0;
  timeLeft = START_SECONDS;
  lastTick = performance.now();
  chest.x=canvas.clientWidth/2; chest.vx=0; placeChest();
  state=State.PLAYING; show(panelStart,false); show(panelPause,false); show(panelWin,false); show(panelTimeup,false);
  refreshHUD(); btnPause.textContent='‚è∏ Pause';
}
function togglePause(forcePause){
  if(state===State.PLAYING && (forcePause??true)){
    state=State.PAUSED; show(panelPause,true); btnPause.textContent='‚èµ Resume';
  }else if(state===State.PAUSED){
    state=State.PLAYING; show(panelPause,false); btnPause.textContent='‚è∏ Pause';
    lastTick = performance.now(); // ÊôÇÈñìÁî±Âë¢‰∏ÄÂàªÁπºÁ∫å
  }
}
function restart(){ show(panelWin,false); show(panelPause,false); show(panelTimeup,false); start(); }

function winAll(){
  state=State.WIN; best=Math.max(best, Math.floor(score));
  localStorage.setItem('neox_catch_best', String(best));
  localStorage.setItem(CARRY_KEY, String(Math.floor(score))); // Â∏∂ÂàÜÊï∏Âéª v2
  refreshHUD(); SFX.win(); show(panelWin,true);
}
function timeUp(){
  if(state!==State.PLAYING) return;
  state=State.PAUSED;
  best=Math.max(best, Math.floor(score));
  localStorage.setItem('neox_catch_best', String(best));
  refreshHUD();
  show(panelPause,false); show(panelWin,false); show(panelTimeup,true);
}

/* ========== Spawn & Loop ========== */
function spawnCoins(dt){
  const L=LEVELS[levelIdx]; spawnTimer-=dt;
  if(spawnTimer<=0 && coins.length<L.concurrent){
    coins.push({
      x: 18 + Math.random()*(canvas.clientWidth-36),  // ÈÅøÂÖçË≤ºÈÇäÁîüÊàê
      y:-20, r:12,
      vy:L.vy[0]+Math.random()*(L.vy[1]-L.vy[0]),
      spin:Math.random()*Math.PI*2, vspin:-0.12+Math.random()*0.24
    });
    spawnTimer=L.spawn[0]+Math.random()*(L.spawn[1]-L.spawn[0]);
  }
}
let last=performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt=Math.min(50, now-last)/16.6667; last=now;

  drawBackground();

  if(state===State.PLAYING){
    // Ë®àÊôÇ
    const elapsed = (now - lastTick)/1000;
    lastTick = now;
    timeLeft = Math.max(0, timeLeft - elapsed);
    if(timeLeft<=0) timeUp();

    // ÁßªÂãï
    chest.vx=(keys.has('L')?-chest.speed:0)+(keys.has('R')?chest.speed:0) || chest.vx*0.92;
    const margin=2;
    chest.x=Math.max(chest.w/2+margin, Math.min(canvas.clientWidth-chest.w/2-margin, chest.x+chest.vx));

    // Coin Êõ¥Êñ∞
    spawnCoins(dt);
    for(const c of coins){ c.y+=c.vy*dt; c.spin+=c.vspin*dt; }

    // Ê©¢ÂúìÂè£Á¢∞Êíû
    const mouth={cx:chest.x, cy:chest.y - chest.h*0.58, rx:chest.w*0.34, ry:chest.h*0.16};
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i]; const ex=(c.x-mouth.cx)/mouth.rx, ey=(c.y-mouth.cy)/mouth.ry;
      if(ex*ex+ey*ey<=1){
        score+=Math.round(10*LEVELS[levelIdx].mult); caughtThisLevel++; coins.splice(i,1); SFX.star(); refreshHUD();
        if(caughtThisLevel>=LEVELS[levelIdx].target){
          if(levelIdx<LEVELS.length-1){ levelIdx++; caughtThisLevel=0; SFX.level(); }
          else{ winAll(); }
        }
      }else if(c.y>canvas.clientHeight+30){ coins.splice(i,1); }
    }
  }

  drawChest(); drawCoins();
}
requestAnimationFrame(loop);

/* ========== Render ========== */
function drawBackground(){
  const w=canvas.clientWidth,h=canvas.clientHeight; ctx.clearRect(0,0,w,h);
  if(!bgReady){ const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#0f1240'); g.addColorStop(1,'#0a0c22'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h); return; }
  const iw=bgImg.width, ih=bgImg.height, ir=iw/ih, cr=w/h; let dw,dh,dx,dy;
  if(ir>cr){ dh=h; dw=h*ir; dx=(w-dw)/2; dy=0; } else { dw=w; dh=w/ir; dx=0; dy=(h-dh)/2; }
  ctx.drawImage(bgImg,dx,dy,dw,dh);
}
function drawChest(){
  const {x,y,w,h}=chest;
  const glow=ctx.createRadialGradient(x,y-24,6,x,y-24,120);
  glow.addColorStop(0,'rgba(43,124,255,0.30)'); glow.addColorStop(1,'rgba(43,124,255,0)');
  ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(x, y-24, 90, 0, Math.PI*2); ctx.fill();
  if(chestReady){ ctx.save(); ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=18; ctx.drawImage(chestImg, x-w/2, y-h, w, h); ctx.restore(); }
  else{ ctx.fillStyle='#1c274f'; ctx.fillRect(x-w/2, y-h, w, h); }
}
function drawCoins(){
  for(const c of coins){
    const size=c.r*3, r=size/2; ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.spin);
    if(coinReady){ ctx.save(); ctx.shadowColor='rgba(255,223,128,.8)'; ctx.shadowBlur=18; ctx.drawImage(coinImg,-r,-r,size,size); ctx.restore(); }
    else{ const g=ctx.createRadialGradient(0,0,r*.2,0,0,r); g.addColorStop(0,'#fff6cc'); g.addColorStop(1,'#e3b23c'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }
}
</script>
</body>
</html>