<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Catch – Level 1</title>
<style>
  html, body { height:100%; margin:0; background:#0a0b1f; color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;
    overflow:hidden; }
  #wrap{ position:relative; height:100%; display:grid; place-items:center; }
  canvas{
    display:block; width:min(92vw,700px); aspect-ratio:9/16; height:auto;
    border-radius:16px; background:#000;
    box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
    touch-action:none;
  }
  .hud{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr auto; pointer-events:none;}
  .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 14px; font-weight:700; }
  .leftGroup{ display:flex; align-items:center; gap:10px; }
  .badges{ display:flex; gap:8px; flex-wrap:wrap;}
  .badge{ padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.08); box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);}

  /* buttons group + “⋯” menu */
  .buttons{ display:flex; gap:8px; pointer-events:auto; }
  #btnMore{ display:none; pointer-events:auto; border:0; border-radius:10px; padding:8px 12px; font-weight:700; background:#1f2648; color:#fff; }
  @media (hover:none), (max-width:820px){
    .buttons{ display:none; }        /* 手機預設收起 */
    #btnMore{ display:inline-block; }/* 顯示「⋯」 */
  }

  button{ pointer-events:auto; border:0; border-radius:10px; padding:8px 12px; font-weight:700; background:#2b7cff; color:#fff; cursor:pointer; box-shadow:0 6px 18px rgba(43,124,255,.35); }
  button.alt{ background:#1f2648; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }

  /* Home */
  #btnHome{ pointer-events:auto; border:0; border-radius:10px; padding:8px 12px;
    font-weight:700; background:#1f2648; color:#fff; box-shadow:inset 0 0 0 1px rgba(255,255,255,.08); }

  .center{ display:grid; place-items:center; padding:10px;}
  .panel{ pointer-events:auto; min-width:clamp(240px,80%,520px); text-align:center; padding:18px 16px 20px; border-radius:14px; background:rgba(10,12,34,.85); box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06); backdrop-filter: blur(4px); }
  .panel h1{ margin:8px 0 6px; font-size: clamp(20px,4.8vw,28px);}
  .panel p{ margin:6px 0 14px; color:#b9c1ff; font-size:14px; line-height:1.5;}
  .panel .row{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap;}
  .hidden{ display:none !important; }
  .level-banner{ position:absolute; left:50%; top:60px; transform:translateX(-50%); background:rgba(255,255,255,.08); border-radius:999px; padding:8px 14px; font-weight:800; letter-spacing:.3px; pointer-events:none; }
  .touch-hints{ position:absolute; inset:0; display:grid; grid-template-columns:1fr 1fr; pointer-events:none; opacity:.08;}
  .touch-hints>div{ border:1px dashed rgba(255,255,255,.12); margin:6px; border-radius:12px; }
  @media (hover:hover) and (pointer:fine){ .touch-hints{ display:none; } }
</style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" width="450" height="800" aria-label="NeoX Catch Level 1"></canvas>

    <div class="hud" aria-live="polite">
      <div class="topbar">
        <div class="leftGroup">
          <button id="btnHome" class="alt" title="Back to Home">⌂ Home</button>
          <div class="badges">
            <div class="badge" id="scoreBadge">Score: 0</div>
            <div class="badge" id="levelBadge">Level 1 / 5</div>
            <div class="badge" id="progressBadge">Progress: 0 / 10</div>
            <div class="badge" id="bestBadge">Best: 0</div>
          </div>
        </div>

        <div>
          <div class="buttons" id="btnGroup">
            <button id="btnSound" class="alt" title="Sound on/off (M)">🔊 Sound</button>
            <button id="btnPause" class="alt" title="Pause/Resume (P)">⏸ Pause</button>
            <button id="btnRestart" title="Restart (R)">🔄 Restart</button>
          </div>
          <button id="btnMore" class="alt" title="Menu">⋯</button>
        </div>
      </div>

      <div class="center">
        <div id="panelStart" class="panel">
          <h1>NeoX Catch – Level 1</h1>
          <p>Move the <b>Treasure Box</b> at the bottom to catch falling <b>NeoX Coins</b>.  
             Reach the target to level up. Keyboard <b>← →</b> or tap/drag left & right.</p>
          <div class="row"><button id="btnStart">▶ Start</button></div>
        </div>

        <div id="panelPause" class="panel hidden">
          <h1>Paused</h1>
          <p>Ready to continue?</p>
          <div class="row">
            <button id="btnResume">⏵ Resume</button>
            <button id="btnRestart2" class="alt">🔄 Restart</button>
          </div>
        </div>

        <div id="panelWin" class="panel hidden">
          <h1>Level 1 Clear!</h1>
          <p><span id="finalScore">Score: 0</span><br><span id="bestScore">Best: 0</span></p>
          <div class="row">
            <button id="btnNextLevel">Next Level ▶</button>
            <button id="btnPlayAgain" class="alt">Play Again</button>
          </div>
          <p id="nextHint" style="margin-top:8px;color:#b9c1ff;font-size:13px;"></p>
        </div>
      </div>

      <div class="level-banner hidden" id="levelBanner">LEVEL 1</div>
      <div class="touch-hints" aria-hidden="true"><div></div><div></div></div>
    </div>
  </div>

<script>
/* ====== Assets URLs ====== */
const BG_URL    = "https://neoxcoin.github.io/neox-game/forest%20background%20.PNG";
const CHEST_URL = "https://neoxcoin.github.io/neox-game/Treasure%20Box.png";
const COIN_URL  = "https://neoxcoin.github.io/neox-emoji-128.png";

/* ====== HiDPI Canvas ====== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function fitHiDPI(){
  const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
  const dpr = Math.max(1, Math.min(devicePixelRatio||1, 2));
  if (canvas.width !== Math.round(cssW*dpr)) {
    canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
  }
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
fitHiDPI(); addEventListener('resize', fitHiDPI);

/* ====== State ====== */
const State = { READY:0, PLAYING:1, PAUSED:2, WIN:3 };
let state = State.READY;

/* ====== HUD ====== */
const scoreBadge   = document.getElementById('scoreBadge');
const levelBadge   = document.getElementById('levelBadge');
const progressBadge= document.getElementById('progressBadge');
const bestBadge    = document.getElementById('bestBadge');
const panelStart   = document.getElementById('panelStart');
const panelPause   = document.getElementById('panelPause');
const panelWin     = document.getElementById('panelWin');
const finalScore   = document.getElementById('finalScore');
const bestScoreEl  = document.getElementById('bestScore');
const levelBanner  = document.getElementById('levelBanner');

/* ====== Images ====== */
const bgImg = new Image(); bgImg.src = BG_URL; let bgReady=false; bgImg.onload=()=>bgReady=true;
const chestImg = new Image(); chestImg.src = CHEST_URL; let chestReady=false; chestImg.onload=()=>chestReady=true;
const coinImg = new Image(); coinImg.src = COIN_URL; let coinReady=false; coinImg.onload=()=>coinReady=true;

/* ====== Chest (player) ====== */
const chest = { x: 225, y: 0, w: 220, h: 160, speed: 6.2, vx: 0 };
function layoutChest(){
  chest.y = canvas.clientHeight - 90;
  const targetW = Math.min(260, canvas.clientWidth * 0.55);
  chest.w = targetW; chest.h = targetW * 0.72;
}
layoutChest(); addEventListener('resize', layoutChest, {passive:true});

/* ====== Utils ====== */
function rand(a,b){ return Math.random()*(b-a)+a; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ====== Levels ====== */
const LEVELS = [
  { target: 10, vy:[2.0, 2.8], spawn:[0.9, 1.2], concurrent: 2, mult:1.0 },
  { target: 25, vy:[2.6, 3.4], spawn:[0.7, 1.0], concurrent: 3, mult:1.2 },
  { target: 45, vy:[3.0, 3.8], spawn:[0.55,0.85], concurrent: 4, mult:1.4 },
  { target: 70, vy:[3.6, 4.6], spawn:[0.45,0.75], concurrent: 5, mult:1.7 },
  { target:100, vy:[4.2, 5.4], spawn:[0.36,0.66], concurrent: 6, mult:2.1 },
];
let levelIdx = 0;
let caughtThisLevel = 0;

/* ====== Score ====== */
let score = 0;
let best = Number(localStorage.getItem('neox_catch_best') || 0);

/* ====== Audio ====== */
let audioCtx = null, masterGain = null;
let soundOn = true;
function ensureAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.8;
  masterGain.connect(audioCtx.destination);
}
async function resumeAudio(){ try{ ensureAudio(); if (audioCtx.state!=='running') await audioCtx.resume(); }catch(e){} }
function beep({freq=440, dur=0.12, type='sine', gain=0.2, decay=0.02, start=0}) {
  if (!soundOn || !audioCtx) return;
  const now = audioCtx.currentTime + start;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type; osc.frequency.setValueAtTime(freq, now);
  g.gain.setValueAtTime(gain, now);
  g.gain.exponentialRampToValueAtTime(0.0001, now + Math.max(0.01, dur - decay));
  osc.connect(g).connect(masterGain); osc.start(now); osc.stop(now + dur);
}
const SFX = {
  click(){ beep({freq:700, dur:0.07, type:'triangle', gain:0.12}); },
  star(){  beep({freq:880, dur:0.08, type:'sine', gain:0.18}); beep({freq:1320, dur:0.10, type:'sine', gain:0.12, start:0.04}); },
  level(){ [500,750,1100].forEach((f,i)=>beep({freq:f, dur:0.10+0.02*i, type:'square', gain:0.15, start:i*0.08})); },
  win(){   [660,880,990,1320].forEach((f,i)=>beep({freq:f, dur:0.14, type:'sine', gain:0.14, start:i*0.09})); },
  toggle(on){ on?beep({freq:900, dur:0.07, type:'triangle', gain:0.15}):beep({freq:300, dur:0.12, type:'triangle', gain:0.12}); }
};

/* ====== UI ====== */
function show(el, s=true){ el.classList.toggle('hidden', !s); }
function flashLevelBanner(text){ levelBanner.textContent=text; show(levelBanner,true); setTimeout(()=>show(levelBanner,false),1100); }
function refreshHUD(){
  scoreBadge.textContent = `Score: ${Math.floor(score)}`;
  levelBadge.textContent = `Level ${levelIdx+1} / 5`;
  progressBadge.textContent = `Progress: ${caughtThisLevel} / ${LEVELS[levelIdx].target}`;
  bestBadge.textContent = `Best: ${Math.floor(best)}`;
  finalScore.textContent = `Score: ${Math.floor(score)}`;
  bestScoreEl.textContent = `Best: ${Math.floor(best)}`;
}
document.getElementById('btnStart').onclick   = () => { SFX.click(); start(); };
document.getElementById('btnPause').onclick   = () => { SFX.click(); togglePause(); };
document.getElementById('btnResume').onclick  = () => { SFX.click(); togglePause(false); };
document.getElementById('btnRestart').onclick = () => { SFX.click(); restart(); };
document.getElementById('btnRestart2').onclick= () => { SFX.click(); restart(); };
document.getElementById('btnPlayAgain').onclick=()=> { SFX.click(); restart(); };
document.getElementById('btnNextLevel').onclick=()=>{ SFX.click(); window.location.href='v2.html'; };
document.getElementById('btnHome').onclick    = ()=>{ SFX.click(); window.location.href='index.html'; };

const btnSound = document.getElementById('btnSound');
btnSound.addEventListener('click', async ()=>{
  await resumeAudio();
  soundOn = !soundOn;
  btnSound.textContent = soundOn ? '🔊 Sound' : '🔈 Mute';
  SFX.toggle(soundOn);
});

/* ⋯ menu（手機用） */
const btnMore = document.getElementById('btnMore');
btnMore.addEventListener('click', ()=>{
  const group = document.getElementById('btnGroup');
  if (getComputedStyle(group).display === 'none'){
    group.style.display='flex'; btnMore.textContent='×';
    setTimeout(()=>{ group.style.display='none'; btnMore.textContent='⋯'; }, 3500);
  }else{
    group.style.display='none'; btnMore.textContent='⋯';
  }
});

/* ====== Input ====== */
const keys = new Set();
addEventListener('keydown', e=>{
  if (e.repeat) return;
  if (e.key === 'ArrowLeft') keys.add('L');
  if (e.key === 'ArrowRight') keys.add('R');
  if (e.key.toLowerCase() === 'p') togglePause();
  if (e.key.toLowerCase() === 'r') restart();
  if (e.key.toLowerCase() === 'm') btnSound.click();
  if (state===State.READY && (e.key===' ' || e.key==='Enter')) start();
});
addEventListener('keyup', e=>{
  if (e.key === 'ArrowLeft') keys.delete('L');
  if (e.key === 'ArrowRight') keys.delete('R');
});
let pointerId=null;
function onPointerDown(e){
  const p=(e.changedTouches&&e.changedTouches[0])||e;
  pointerId = p.identifier ?? 'mouse';
  if (state===State.READY) start();
  e.preventDefault();
}
function onPointerMove(e){
  const p=(e.changedTouches && ([...e.changedTouches].find(t => (t.identifier ?? 'mouse')===pointerId)))||e;
  if (!p) return;
  const rect = canvas.getBoundingClientRect();
  const cx = (p.clientX - rect.left) / rect.width * canvas.clientWidth;
  const diff = cx - chest.x;
  chest.vx = clamp(diff*0.25, -chest.speed, chest.speed);
  e.preventDefault();
}
function onPointerUp(e){ pointerId=null; chest.vx=0; e.preventDefault(); }
canvas.addEventListener('pointerdown', onPointerDown, {passive:false});
addEventListener('pointermove', onPointerMove, {passive:false});
addEventListener('pointerup', onPointerUp, {passive:false});
addEventListener('pointercancel', onPointerUp, {passive:false});
['pointerdown','keydown'].forEach(evt=>{
  window.addEventListener(evt, resumeAudio, {once:true, passive:true});
});
addEventListener('blur', ()=>{ if(state===State.PLAYING) togglePause(true); });

/* ====== Flow ====== */
let spawnTimer = 0;
const coins = [];
function start(){
  score = 0; levelIdx = 0; caughtThisLevel = 0; coins.length = 0; spawnTimer = 0;
  chest.x = canvas.clientWidth/2; chest.vx=0;
  state = State.PLAYING;
  show(panelStart,false); show(panelPause,false); show(panelWin,false);
  flashLevelBanner('LEVEL 1');
  refreshHUD();
}
function togglePause(forcePause){
  if (state===State.PLAYING && (forcePause ?? true)) {
    state = State.PAUSED; show(panelPause,true);
    document.getElementById('btnPause').textContent = '⏵ Resume';
  } else if (state===State.PAUSED) {
    state = State.PLAYING; show(panelPause,false);
    document.getElementById('btnPause').textContent = '⏸ Pause';
  }
}
function restart(){ show(panelWin,false); show(panelPause,false); start(); }
function win(){
  state = State.WIN;
  best = Math.max(best, Math.floor(score));
  localStorage.setItem('neox_catch_best', String(best));
  refreshHUD(); SFX.win(); show(panelWin,true);
  // ❌ 不自動跳下一關（按鈕決定）
}

/* ====== Coins ====== */
function spawnCoins(dt){
  const L = LEVELS[levelIdx];
  spawnTimer -= dt;
  const currentMax = L.concurrent;
  if (spawnTimer <= 0 && coins.length < currentMax) {
    coins.push({
      x: rand(18, canvas.clientWidth-18), y: -20,
      r: 12, vy: rand(L.vy[0], L.vy[1]),
      spin: rand(0,Math.PI*2), vspin: rand(-0.12,0.12)
    });
    spawnTimer = rand(L.spawn[0], L.spawn[1]);
  }
}

/* ====== Loop ====== */
let last = performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt = Math.min(50, now-last)/16.6667; last = now;

  drawBackground();

  if (state === State.PLAYING){
    chest.vx = (keys.has('L') ? -chest.speed : 0) + (keys.has('R') ? chest.speed : 0) || chest.vx*0.92;
    chest.x += chest.vx;
    chest.x = clamp(chest.x, chest.w/2 + 8, canvas.clientWidth - chest.w/2 - 8);

    spawnCoins(dt);
    for (let c of coins){ c.y += c.vy*dt; c.spin += c.vspin*dt; }

    // 橢圓形「箱口」判定
    const mouth = {
      cx: chest.x,
      cy: chest.y - chest.h*0.58,
      rx: chest.w * 0.34,
      ry: chest.h * 0.16
    };

    for (let i=coins.length-1; i>=0; i--){
      const c = coins[i];
      const ex = (c.x - mouth.cx) / mouth.rx;
      const ey = (c.y - mouth.cy) / mouth.ry;
      const inside = (ex*ex + ey*ey) <= 1;
      if (inside){
        const mult = LEVELS[levelIdx].mult;
        score += Math.round(10 * mult);
        caughtThisLevel++;
        coins.splice(i,1);
        SFX.star();
        if (caughtThisLevel >= LEVELS[levelIdx].target){
          if (levelIdx < LEVELS.length-1){
            levelIdx++; caughtThisLevel = 0; flashLevelBanner(`LEVEL ${levelIdx+1}`); SFX.level();
          } else { win(); }
        }
        refreshHUD();
      } else if (c.y > canvas.clientHeight + 30){
        coins.splice(i,1);
      }
    }
  }

  drawChest();
  drawCoins();

  if (state === State.READY){
    ctx.font='600 18px system-ui, -apple-system, "Segoe UI"';
    ctx.textAlign='center'; ctx.fillStyle='rgba(255,255,255,.9)';
    ctx.fillText('Tap or press Space to start', canvas.clientWidth/2, canvas.clientHeight*0.62);
  }
}
requestAnimationFrame(loop);

/* ====== Rendering ====== */
function drawBackground(){
  const w=canvas.clientWidth, h=canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  if (!bgReady){
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,"#0f1240"); g.addColorStop(1,"#0a0c22");
    ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
    return;
  }
  // object-fit: cover
  const iw = bgImg.width, ih = bgImg.height, ir = iw/ih, cr = w/h;
  let dw, dh, dx, dy;
  if (ir > cr) { dh = h; dw = h*ir; dx = (w-dw)/2; dy = 0; }
  else { dw = w; dh = w/ir; dx = 0; dy = (h-dh)/2; }
  ctx.drawImage(bgImg, dx, dy, dw, dh);
}
function drawChest(){
  const {x,y,w,h} = chest;
  const grad = ctx.createRadialGradient(x, y-24, 6, x, y-24, 120);
  grad.addColorStop(0,'rgba(43,124,255,0.30)');
  grad.addColorStop(1,'rgba(43,124,255,0)');
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.arc(x, y-24, 90, 0, Math.PI*2); ctx.fill();

  if (chestReady){
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,0.35)';
    ctx.shadowBlur = 18;
    ctx.drawImage(chestImg, x - w/2, y - h, w, h);
    ctx.restore();
  } else {
    ctx.fillStyle = '#1c274f';
    ctx.fillRect(x - w/2, y - h, w, h);
  }
}
function drawCoins(){ for (let c of coins){ drawCoin(c.x, c.y, c.r*3, c.spin); } }
function drawCoin(x, y, size, rot){
  const r = size/2;
  ctx.save(); ctx.translate(x, y); ctx.rotate(rot);
  if (coinReady){
    ctx.save(); ctx.shadowColor = 'rgba(255,223,128,0.8)'; ctx.shadowBlur = 18;
    ctx.drawImage(coinImg, -r, -r, size, size); ctx.restore();
  } else {
    const grad = ctx.createRadialGradient(0,0,r*0.2,0,0,r);
    grad.addColorStop(0,'#fff6cc'); grad.addColorStop(1,'#e3b23c');
    ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#402f00'; ctx.font = `${r*1.2}px Arial Black`;
    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('N', 0, 2);
  }
  ctx.restore();
}
</script>
</body>
</html>