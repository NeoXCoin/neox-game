<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>NeoX Catch – v1</title>
<style>
  html,body{margin:0;height:100%;background:#0a0b1f;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans TC",Arial,sans-serif;overflow:hidden}
  #wrap{position:relative;height:100%;display:grid;place-items:center}
  canvas{
    display:block;width:min(92vw,820px);aspect-ratio:9/16;height:auto;
    border-radius:16px;background:#0b1130 url("https://neoxcoin.github.io/neox-game/forest%20background%20.PNG") center/cover no-repeat;
    box-shadow:0 20px 60px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.06);
    touch-action:none
  }

  .hud{position:absolute;inset:0;pointer-events:none}
  .topbar{position:absolute;left:12px;right:12px;top:8px;display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .badges{display:grid;grid-auto-flow:row;gap:8px}
  .badge{padding:10px 14px;border-radius:14px;font-weight:900;background:rgba(0,0,0,.42);box-shadow:0 8px 24px rgba(0,0,0,.22),inset 0 0 0 1px rgba(255,255,255,.08);backdrop-filter:blur(6px)}
  .badge.level{visibility:hidden} /* Lv2 才顯示 */

  /* 右上：預設只見 ⋯ Menu，按落先見控制鍵 */
  .controls{display:flex;gap:8px;pointer-events:auto}
  .controls>button,.controls>a{display:none}
  .controls.show>button,.controls.show>a{display:inline-flex}
  button{pointer-events:auto;border:0;border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer}
  .btn{background:#2b7cff;color:#fff;box-shadow:0 6px 18px rgba(43,124,255,.35)}
  .alt{background:rgba(22,27,64,.9);color:#fff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.12)}
  #btnMenu{width:44px;aspect-ratio:1/1;display:grid;place-items:center}
  #btnMenu::after{content:"⋯";font-size:22px;line-height:1}

  .center{position:absolute;inset:0;display:grid;place-items:center}
  .panel{pointer-events:auto;min-width:clamp(240px,80%,520px);text-align:center;padding:18px 16px 20px;border-radius:14px;background:rgba(10,12,34,.85);box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06);backdrop-filter: blur(4px)}
  .hidden{display:none!important}

  .level-banner{position:absolute;left:50%;top:60px;transform:translateX(-50%);background:rgba(255,255,255,.08);border-radius:999px;padding:8px 14px;font-weight:800;letter-spacing:.3px;pointer-events:none;opacity:0;transition:opacity .25s}
  .level-banner.show{opacity:1}

  @media (max-width:700px){ .topbar{top:6px} .badge{padding:9px 12px} }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="450" height="800" aria-label="NeoX Catch v1"></canvas>

  <div class="hud" aria-live="polite">
    <div class="topbar">
      <!-- 左上：只顯示 Score / Level(升級後才顯示) -->
      <div class="badges">
        <div class="badge" id="scoreB">分數：0</div>
        <div class="badge level" id="levelB">Level 1 / 5</div>
      </div>

      <!-- 右上：Menu -> 展開 Sound/Pause/Restart/Home -->
      <div class="controls" id="controls">
        <button id="btnMenu" class="alt" title="Menu"></button>
        <a class="alt" href="index.html">🏠 Home</a>
        <button id="btnSound" class="alt">🔊 Sound</button>
        <button id="btnPause" class="alt">⏸ Pause</button>
        <button id="btnRestart" class="btn">🔄 Restart</button>
      </div>
    </div>

    <div class="center">
      <div id="panelStart" class="panel">
        <h1>NeoX Catch – Level 1</h1>
        <p>用底部的托盤左右移動，接住掉下來的 <b>NeoX Coin</b> 🟡。完成目標就升級。<br>鍵盤 ← →，或手機點/拖左右半邊。</p>
        <button id="btnStart" class="btn">▶ 開始</button>
      </div>

      <div id="panelPause" class="panel hidden">
        <h2>暫停</h2>
        <div style="display:flex;gap:10px;justify-content:center">
          <button id="btnResume" class="btn">⏵ 繼續</button>
          <button id="btnRestart2" class="alt">🔄 重開</button>
        </div>
      </div>

      <div id="panelWin" class="panel hidden">
        <h2>Level 1 完成！🎉</h2>
        <p><span id="finalScore">分數：0</span></p>
        <div style="display:flex;gap:10px;justify-content:center">
          <a class="btn" href="v2.html">➡ 下一關</a>
        </div>
      </div>
    </div>

    <div class="level-banner" id="levelBanner">LEVEL 2</div>
  </div>
</div>

<script>
/* ===== Canvas HiDPI ===== */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
function fitHiDPI(){const w=cvs.clientWidth,h=cvs.clientHeight,dpr=Math.max(1,Math.min(devicePixelRatio||1,2)); if(cvs.width!==Math.round(w*dpr)){cvs.width=Math.round(w*dpr);cvs.height=Math.round(h*dpr);} ctx.setTransform(dpr,0,0,dpr,0,0);}
fitHiDPI(); addEventListener('resize',fitHiDPI);

/* ===== Menu ===== */
const controls=document.getElementById('controls');
document.getElementById('btnMenu').onclick=()=>controls.classList.toggle('show');

/* ===== State & HUD ===== */
const LEVELS=[
  {target:10,  vy:[2.0,2.8], spawn:[0.9,1.2], concurrent:2, mult:1.0},
  {target:25,  vy:[2.6,3.4], spawn:[0.7,1.0], concurrent:3, mult:1.2},
  {target:45,  vy:[3.0,3.8], spawn:[0.55,0.85],concurrent:4, mult:1.4},
  {target:70,  vy:[3.6,4.6], spawn:[0.45,0.75],concurrent:5, mult:1.7},
  {target:100, vy:[4.2,5.4], spawn:[0.36,0.66],concurrent:6, mult:2.1},
];
let levelIdx=0, caught=0, score=0;
const scoreB=document.getElementById('scoreB'), levelB=document.getElementById('levelB'), levelBanner=document.getElementById('levelBanner');
const panelStart=document.getElementById('panelStart'), panelPause=document.getElementById('panelPause'), panelWin=document.getElementById('panelWin'), finalScore=document.getElementById('finalScore');
function show(el, s=true){ el.classList.toggle('hidden', !s); }
function refreshHUD(){
  scoreB.textContent=`分數：${Math.floor(score)}`;
  levelB.textContent=`Level ${levelIdx+1} / 5`;
  levelB.style.visibility = (levelIdx>0)?'visible':'hidden'; // Lv2 才顯示
}
function flash(text){ levelBanner.textContent=text; levelBanner.classList.add('show'); setTimeout(()=>levelBanner.classList.remove('show'),1100); }

/* ===== Old gameplay variables (最少改動) ===== */
const coinImg=new Image(); coinImg.src="https://neoxcoin.github.io/neox-emoji-128.png"; let coinReady=false; coinImg.onload=()=>coinReady=true;
const coins=[]; let spawn=0;
const bowl={x:cvs.clientWidth/2,y:0,w:120,h:16,r:10,speed:6.2,vx:0};
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function rand(a,b){return Math.random()*(b-a)+a}

/* ===== Audio（保持簡單） ===== */
let audioCtx=null, master=null, soundOn=true;
function ensureAudio(){ if(audioCtx) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)(); master=audioCtx.createGain(); master.gain.value=.8; master.connect(audioCtx.destination); }
async function resumeAudio(){ try{ ensureAudio(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch{} }
function beep(f=880,d=.08,g=.18){ if(!soundOn||!audioCtx) return; const now=audioCtx.currentTime; const o=audioCtx.createOscillator(), gn=audioCtx.createGain(); o.frequency.value=f; gn.gain.value=g; gn.gain.exponentialRampToValueAtTime(.0001, now+d*.9); o.connect(gn).connect(master); o.start(now); o.stop(now+d); }
const SFX={catch(){beep(1100,.09,.2)},level(){[520,760,1120].forEach((f,i)=>setTimeout(()=>beep(f,.1,.16),i*80))},win(){[660,880,990,1320].forEach((f,i)=>setTimeout(()=>beep(f,.12,.18),i*90))}};

/* ===== Controls ===== */
const keys=new Set();
addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') keys.add('L');
  if(e.key==='ArrowRight') keys.add('R');
  if(e.key.toLowerCase()==='p') togglePause();
  if(e.key.toLowerCase()==='r') restart();
  if(e.key.toLowerCase()==='m') document.getElementById('btnSound').click();
  if(panelStart && !panelStart.classList.contains('hidden') && (e.key===' '||e.key==='Enter')) start();
});
addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft') keys.delete('L');
  if(e.key==='ArrowRight') keys.delete('R');
});
let pointerId=null;
cvs.addEventListener('pointerdown',e=>{pointerId=e.pointerId; if(!panelStart.classList.contains('hidden')) start(); e.preventDefault();},{passive:false});
addEventListener('pointermove',e=>{
  if(pointerId==null) return;
  const r=cvs.getBoundingClientRect(); const cx=(e.clientX-r.left)/r.width*cvs.clientWidth;
  const diff=cx-bowl.x; bowl.vx=clamp(diff*0.25,-bowl.speed,bowl.speed);
},{passive:true});
['pointerup','pointercancel','pointerleave'].forEach(evt=>addEventListener(evt,()=>{pointerId=null; bowl.vx=0;}));

/* ===== Buttons ===== */
document.getElementById('btnStart').onclick=()=>start();
document.getElementById('btnPause').onclick=()=>togglePause();
document.getElementById('btnResume').onclick=()=>togglePause(false);
document.getElementById('btnRestart').onclick=()=>restart();
document.getElementById('btnRestart2').onclick=()=>restart();
const btnSound=document.getElementById('btnSound'); btnSound.onclick=async()=>{await resumeAudio(); soundOn=!soundOn; btnSound.textContent = soundOn?'🔊 Sound':'🔈 Mute';};
addEventListener('blur',()=>togglePause(true));
['pointerdown','keydown'].forEach(evt=>addEventListener(evt,resumeAudio,{once:true,passive:true}));

/* ===== Start / Pause / Win ===== */
function start(){
  score=0; levelIdx=0; caught=0; coins.length=0; spawn=0;
  bowl.w=Math.max(100,Math.min(180,cvs.clientWidth*.28)); bowl.h=16; bowl.r=10;
  const bottomMargin = Math.max(24, Math.round(cvs.clientHeight * 0.04));
  bowl.y = cvs.clientHeight - bottomMargin;
  bowl.x=cvs.clientWidth/2; bowl.vx=0;
  show(panelStart,false); show(panelPause,false); show(panelWin,false);
  flash('LEVEL 1'); refreshHUD();
}
let paused=false;
function togglePause(force){ paused = (force===undefined)? !paused : force; show(panelPause,paused); document.getElementById('btnPause').textContent = paused?'⏵ Resume':'⏸ Pause'; }
function restart(){ start(); }
function win(){ show(panelWin,true); finalScore.textContent=`分數：${Math.floor(score)}`; SFX.win(); setTimeout(()=>location.href='v2.html',1400); }

/* ===== Spawning & Loop ===== */
function spawnCoin(){ const L=LEVELS[levelIdx]; coins.push({x:rand(18,cvs.clientWidth-18),y:-20,r:12,vy:rand(L.vy[0],L.vy[1]),spin:0,vspin:rand(-.12,.12)}); spawn=rand(LEVELS[levelIdx].spawn[0],LEVELS[levelIdx].spawn[1]); }
function drawBowl(){
  // 光暈
  const grad=ctx.createRadialGradient(bowl.x,bowl.y,6,bowl.x,bowl.y,90);
  grad.addColorStop(0,'rgba(43,124,255,.35)'); grad.addColorStop(1,'rgba(43,124,255,0)');
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(bowl.x,bowl.y,80,0,Math.PI*2); ctx.fill();
  // 托盤（舊版樣式）
  roundRect(bowl.x-bowl.w/2,bowl.y-bowl.h/2,bowl.w,bowl.h,bowl.r,'#1c274f','#90bfff');
  ctx.beginPath(); ctx.ellipse(bowl.x,bowl.y-bowl.h/2,bowl.w*.48,bowl.h*.85,0,Math.PI,0); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2; ctx.stroke();
}
function roundRect(x,y,w,h,r,fill,hl){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fillStyle=fill; ctx.fill(); ctx.strokeStyle=hl; ctx.globalAlpha=.35; ctx.lineWidth=2; ctx.stroke(); ctx.globalAlpha=1; }
function drawCoins(){ for(const c of coins){ c.spin+=c.vspin; ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.spin); if(coinReady){ ctx.shadowColor='rgba(255,223,128,.8)'; ctx.shadowBlur=18; ctx.drawImage(coinImg,-16,-16,32,32);} else { ctx.fillStyle='#ffd83a'; ctx.beginPath(); ctx.arc(0,0,14,0,Math.PI*2); ctx.fill(); } ctx.restore(); } }

let last=performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt=Math.min(50, now-last)/16.6667; last=now;

  // 背景暗角
  const w=cvs.clientWidth,h=cvs.clientHeight;
  const g=ctx.createRadialGradient(w*.5,h*.8,10,w*.5,h*.8,Math.max(w,h)*.9);
  g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,.18)'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

  if(!panelStart.classList.contains('hidden')||paused){
    drawBowl(); drawCoins();
    return;
  }

  // 移動托盤
  const keyVX=(keys.has('L')?-bowl.speed:0)+(keys.has('R')?bowl.speed:0);
  bowl.vx= keyVX || bowl.vx*0.92;
  bowl.x=clamp(bowl.x+bowl.vx, bowl.w/2+8, cvs.clientWidth-bowl.w/2-8);

  // 生成 & 移動硬幣
  spawn -= dt; if(spawn<=0 && coins.length<LEVELS[levelIdx].concurrent) spawnCoin();
  for(const c of coins){ c.y += (LEVELS[levelIdx].vy[0])*dt + (c.vy-LEVELS[levelIdx].vy[0]); }

  // 碰撞 & 升級
  for(let i=coins.length-1;i>=0;i--){
    const c=coins[i];
    const rx=bowl.x-bowl.w/2, ry=bowl.y-bowl.h/2, rw=bowl.w, rh=bowl.h;
    const nx=clamp(c.x,rx,rx+rw), ny=clamp(c.y,ry,ry+rh);
    const dx=c.x-nx, dy=c.y-ny;
    if(dx*dx+dy*dy<=c.r*c.r){
      score += Math.round(10*LEVELS[levelIdx].mult);
      coins.splice(i,1);
      SFX.catch();
      caught++;
      if(caught>=LEVELS[levelIdx].target){
        if(levelIdx<LEVELS.length-1){
          levelIdx++; caught=0; flash(`LEVEL ${levelIdx+1}`); SFX.level(); if(levelIdx===1) levelB.style.visibility='visible';
        }else{
          show(panelWin,true);
          finalScore.textContent=`分數：${Math.floor(score)}`;
          SFX.win();
          setTimeout(()=>location.href='v2.html',1400);
        }
      }
      refreshHUD();
    }else if(c.y>cvs.clientHeight+24){ coins.splice(i,1); }
  }

  drawBowl(); drawCoins();
}
requestAnimationFrame(loop);

/* ===== UI ===== */
function start(){ resumeAudio(); show(panelStart,false); refreshHUD(); }
function togglePause(force){ /* 已在上面定義 */ }
function restart(){ show(panelWin,false); show(panelPause,false); levelIdx=0; caught=0; score=0; coins.length=0; spawn=0; refreshHUD(); }

/* 初始 */
refreshHUD();
</script>
</body>
</html>