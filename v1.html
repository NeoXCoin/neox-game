<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Catch – Level 1</title>
<style>
  html,body{
    height:100%;margin:0;background:#0a0b1f;color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans",Arial,sans-serif;
    overflow:hidden;
  }
  #wrap{position:relative;height:100%;display:grid;place-items:center;}
  canvas{
    display:block;width:min(92vw,700px);aspect-ratio:9/16;height:auto;
    border-radius:16px;background:#000;
    box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
    touch-action:none;
    position:relative; z-index:1;
  }

  /* HUD */
  .hud{position:absolute; inset:0; z-index:5; pointer-events:none; display:grid; grid-template-rows:auto 1fr;}
  @media (max-width: 600px) {
    .topbar{ position:relative; display:block; padding:10px 14px; }
    .topbar .left  { position:absolute; left:10px;  top:12px; }
    .topbar .right { position:absolute; right:10px; top:12px; }
    .topbar .center{
      position:absolute; left:50%; top:10px; transform:translateX(-50%);
      text-align:center; pointer-events:none;
    }
  }
  .topbar{
    display:grid;
    grid-template-columns:minmax(0,1fr) auto minmax(0,1fr);
    align-items:start; gap:10px; padding:10px 14px; font-weight:800;
    justify-items:center;
  }
  .left{  justify-self:start; pointer-events:auto; }
  .center{justify-self:center; text-align:center; pointer-events:none; }
  .right{ justify-self:end;   pointer-events:auto; }
  .badge{
    display:inline-block;padding:8px 12px;border-radius:12px;
    background:rgba(255,255,255,.14);backdrop-filter:blur(3px);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);margin:0 6px;font-weight:900;
  }
  .iconbtn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background:#1b2144;
    border:0;
    color:#fff;
    border-radius:14px;
    padding:12px 16px;              /* ← 原本 10px 14px，整體放大少少 */
    font-weight:800;
    box-shadow:0 10px 28px rgba(0,0,0,.25),
               inset 0 0 0 1px rgba(255,255,255,.08);
    cursor:pointer;
    pointer-events:auto;
    transition:transform .1s ease;
  }
  .iconbtn:hover{ transform:scale(1.05); } /* 小小互動感覺 */
  .iconbtn img{
    width:28px; height:28px;       /* ← 原本 22px，放大到 28px */
    object-fit:contain;
    display:block;
  }

  .panel{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    pointer-events:auto; z-index:10;
    min-width:clamp(240px,80%,520px); text-align:center;
    padding:18px 16px 20px;border-radius:16px;background:rgba(10,12,34,.88);
    box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.08);
    backdrop-filter:blur(4px);
  }
  .panel h1{margin:8px 0 10px;font-size:clamp(22px,5.2vw,30px);}
  .panel p{margin:0 0 14px;color:#c8d2ff;font-size:14px;line-height:1.55;}
  .row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;color:#fff;background:#2b7cff;
       box-shadow:0 8px 22px rgba(43,124,255,.35);}
  .btn.alt{background:#1f2648;box-shadow:inset 0 0 0 1px rgba(255,255,255,.1);}
  .hidden{display:none !important;}

  /* === 固定 2×2 分數牌（不會跳位，也不會被 Safari 地址列頂住） === */
  .scoreboard{
    position:absolute;
    /* 頂邊加上 safe-area，避免同「X / Pause」重疊；可以按需要微調 +8→+10/12 */
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    gap: 6px;                /* 上下行距 */
    pointer-events: none;
    z-index: 10;
  }

  /* 每行兩個，置中排列 */
  .scoreboard .srow{
    display: flex;
    gap: 8px;                /* 左右距 */
    justify-content: center;
  }

  /* 統一每個框的尺寸（細啲），禁止換行，數字用等寬表現 */
  .scoreboard .badge{
    width: 116px;            /* ← 再收窄：框唔會過大 */
    height: 30px;
    line-height: 30px;
    margin: 0;               /* 務必為 0，否則看起來會「靠埋」或重疊 */
    font-size: 13px;
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum" 1, "lnum" 1;
    text-align: center;
    color: #fff;
    background: rgba(255,255,255,.08);
    backdrop-filter: blur(6px);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
    border-radius: 10px;
  }

  /* 重要：避免手機 breakpoint 對 .center 的定位影響到 scoreboard */
  .topbar .center{ position: static; transform: none; }

  /* 極窄螢幕（可選）再細少少 */
  @media (max-width: 280px){
    .scoreboard .badge{ width: 108px; font-size: 12.5px; }
  }

  /* iPad 直向可再落少少，避開 Pause/X（可選） */
  @media (min-width: 768px) and (orientation: portrait){
    .scoreboard{ top: calc(env(safe-area-inset-top, 0px) + 12px); }
}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="450" height="800" aria-label="NeoX Catch Level 1"></canvas>

  <div class="hud" aria-live="polite">
    <div class="topbar">
      <div class="left">
        <button id="btnHome" class="iconbtn" title="Back to Home">
          <img src="https://neoxcoin.github.io/neox-game/XNXC.png" alt="Home">
        </button>
      </div>

      <!-- 固定在畫面頂部中央的 2×2 分數牌 -->
      <div class="scoreboard" id="scoreboard">
        <div class="srow">
          <span class="badge" id="scoreBadge">Score: 00000</span>
          <span class="badge" id="timeBadge">Time: 03:00</span>
        </div>
        <div class="srow">
          <span class="badge" id="bestBadge">Best: 00000</span>
          <span class="badge" id="missBadge">Miss: 00/50</span>
        </div>
      </div>

      <div class="right">
        <button id="btnPause" class="iconbtn" title="Pause/Resume (P)">⏸</button>
      </div>
    </div>

    <!-- Panels -->
    <div id="panelStart" class="panel">
      <h1>NeoX Catch — Level 1</h1>
      <p>Move the <b>Treasure Box</b> to catch falling <b>NeoX Coins</b>.<br>
         Keyboard <b>← →</b> or drag left & right.</p>
      <div class="row"><button id="btnStart" class="btn">▶ Start</button></div>
    </div>

    <div id="panelPause" class="panel hidden">
      <h1>Paused</h1>
      <div class="row">
        <button id="btnResume" class="btn">⏵ Resume</button>
        <button id="btnRestart2" class="btn alt">🔄 Restart</button>
      </div>
    </div>

    <div id="panelWin" class="panel hidden">
      <h1 id="winTitle">Time’s up ⏱️</h1>
      <p><span id="finalScore">Score: 0</span> · <span id="bestScore">Best: 0</span></p>
      <div class="row">
        <button id="btnNextLevel" class="btn">Go to Level 2 ▶</button>
        <button id="btnReplay" class="btn alt">Replay</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== 防熱鏈／父頁來源檢查 ====== */
(function(){
  const ALLOWED_PARENT_ORIGIN = 'https://neoxcoin.github.io';
  if (window.top !== window.self) {
    try {
      const ref = document.referrer || '';
      const parentOrigin = ref ? new URL(ref).origin : '';
      if (parentOrigin !== ALLOWED_PARENT_ORIGIN) {
        window.top.location.replace('https://neoxcoin.github.io/neox-game/');
      }
    } catch (e) {
      window.top.location.replace('https://neoxcoin.github.io/neox-game/');
    }
  }
})();

/* ====== Config ====== */
const TOTAL_TIME_SEC = 180;
const EDGE = 2;
const MAX_MISSES = 50;

/* ====== Assets ====== */
const BG_URL    = "https://neoxcoin.github.io/neox-game/forest%20background%20.PNG";
const CHEST_URL = "https://neoxcoin.github.io/neox-game/treasure-box.png";
const COIN_URL  = "https://neoxcoin.github.io/neox-game/NeoXCoin.Front.png";

/* ====== Canvas (HiDPI) ====== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function fitHiDPI(){
  const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
  const dpr = Math.max(1, Math.min(devicePixelRatio||1, 2));
  if (canvas.width !== Math.round(cssW*dpr)) {
    canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
  }
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
fitHiDPI(); addEventListener('resize', fitHiDPI);

/* ====== State ====== */
const State={READY:0,PLAYING:1,PAUSED:2,WIN:3,OVER:4};
let state=State.READY;

/* ====== HUD refs ====== */
const scoreBadge   = document.getElementById('scoreBadge');
const bestBadge    = document.getElementById('bestBadge');
const timeBadge    = document.getElementById('timeBadge');
const missBadge    = document.getElementById('missBadge');
const panelStart   = document.getElementById('panelStart');
const panelPause   = document.getElementById('panelPause');
const panelWin     = document.getElementById('panelWin');
const finalScore   = document.getElementById('finalScore');
const bestScore    = document.getElementById('bestScore');
const winTitle     = document.getElementById('winTitle');
const btnNextLevel = document.getElementById('btnNextLevel');
const btnReplay    = document.getElementById('btnReplay');

/* ====== Images ====== */
const bgImg=new Image(); bgImg.src=BG_URL; let bgReady=false; bgImg.onload=()=>bgReady=true;
const chestImg=new Image(); chestImg.src=CHEST_URL; let chestReady=false; chestImg.onload=()=>chestReady=true;
const coinImg=new Image(); coinImg.src=COIN_URL; let coinReady=false; coinImg.onload=()=>coinReady=true;

/* ====== Player (Chest) ====== */
const chest={x:225,y:0,w:220,h:160,speed:6.2,vx:0};
function isMobile(){return /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent);}
function visibleCanvasHeight(){
  const rect=canvas.getBoundingClientRect(); const vp=window.visualViewport;
  if(vp){ const vb=(vp.offsetTop||0)+vp.height; return Math.max(0, Math.min(rect.bottom,vb)-rect.top); }
  return rect.height;
}
function placeChest(){
  const H=visibleCanvasHeight();
  const land=matchMedia('(orientation: landscape)').matches;
  const bottomMargin = isMobile()? 18 : (land ? Math.max(24, H*0.05) : Math.max(24, H*0.035));
  const targetW = Math.min(canvas.clientWidth*(isMobile()?0.30:0.28), 280);
  chest.w = targetW; chest.h = Math.round(targetW*0.72);
  chest.y = Math.max(chest.h, H - bottomMargin);
  const cx = (chest.x || canvas.clientWidth/2);
  chest.x = Math.max(chest.w/2 + EDGE, Math.min(cx, canvas.clientWidth - chest.w/2 - EDGE));
}
placeChest();
addEventListener('resize', placeChest);
addEventListener('orientationchange', placeChest);

/* ====== Score/Timer/Miss ====== */
let score=0;
let best = Number(localStorage.getItem('neox_catch_best_l1') ?? localStorage.getItem('neox_catch_best') ?? 0);
let timeLeft = TOTAL_TIME_SEC;
let missCount = 0;

/* === 固定位寬的格式化（避免跳位） === */
const PAD_SCORE = 5;
const PAD_MISS  = String(MAX_MISSES).length;
const MAX_MISS_STR = String(MAX_MISSES);
const zpad = (n, w) => String(Math.floor(n)).padStart(w, '0');

function fmt(t){
  const m=Math.floor(t/60), s=Math.floor(t%60);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function refreshHUD(){
  scoreBadge.textContent = `Score: ${zpad(score, PAD_SCORE)}`;
  bestBadge.textContent  = `Best: ${zpad(best,  PAD_SCORE)}`;
  timeBadge.textContent  = `Time: ${fmt(timeLeft)}`;
  missBadge.textContent  = `Miss: ${zpad(missCount, PAD_MISS)}/${MAX_MISS_STR}`;

  finalScore.textContent = `Score: ${Math.floor(score)}`;
  bestScore.textContent  = `Best: ${Math.floor(best)}`;

  // 🛰️ 向 iframe 傳送即時分數
  window.parent?.postMessage({ type:'NX_CARRY', score: Math.floor(score) }, '*');
}

/* ====== Audio (mobile-safe) ====== */
let audioCtx = null, masterGain = null;
function ensureAudio(){
  if (audioCtx) return;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  audioCtx = new Ctx();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.8;
  masterGain.connect(audioCtx.destination);
}
function unlockAudioOnce(){
  ensureAudio();
  if (!audioCtx) return;
  const buf = audioCtx.createBuffer(1, 1, 22050);
  const src = audioCtx.createBufferSource();
  src.buffer = buf;
  src.connect(masterGain);
  try { src.start(0); } catch(e){}
}
async function resumeAudio(){
  ensureAudio();
  try{
    unlockAudioOnce();
    if (audioCtx.state === 'suspended') await audioCtx.resume();
  }catch(e){}
}
function beep(f=440,d=0.12,v=0.2,type='sine'){
  ensureAudio();
  if (!audioCtx || audioCtx.state!=='running') return;
  const n=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.setValueAtTime(f,n); g.gain.setValueAtTime(v,n);
  g.gain.exponentialRampToValueAtTime(0.0001, n + d*0.9);
  o.connect(g).connect(masterGain); o.start(n); o.stop(n+d);
}
const SFX = {
  click(){ beep(700,.07,.12,'triangle'); },
  star(){  beep(880,.08,.18); setTimeout(()=>beep(1320,.10,.12),40); },
  win(){   [660,880,990,1320].forEach((f,i)=>setTimeout(()=>beep(f,.14,.16),90*i)); },
  miss(){  beep(260,.12,.18); },
  over(){  [300,260,220].forEach((f,i)=>setTimeout(()=>beep(f,.18,.22),120*i)); }
};
['pointerdown','touchend','mousedown','keydown','click'].forEach(evt=>{
  window.addEventListener(evt, resumeAudio, {once:true, passive:true});
});
document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState === 'visible') resumeAudio(); });

/* ====== Buttons ====== */
document.getElementById('btnHome').onclick = () => {
  (window.top || window).location.replace('https://neoxcoin.github.io/');
};
document.getElementById('btnStart').onclick=()=>{start();};
document.getElementById('btnRestart2').onclick=()=>{restart();};
document.getElementById('btnReplay').onclick=()=>{restart();};
document.getElementById('btnResume').onclick=()=>{togglePause(false);};
const btnPause=document.getElementById('btnPause');
btnPause.onclick=()=>togglePause();

btnNextLevel.onclick = () => {
  localStorage.setItem('nx_carry', String(Math.floor(score)));
  window.location.href = 'v2.html#continue';
};

/* ====== Input ====== */
const keys=new Set();
addEventListener('keydown',e=>{
  if(e.repeat) return;
  if(e.key==='ArrowLeft') keys.add('L');
  if(e.key==='ArrowRight') keys.add('R');
  if(e.key.toLowerCase()==='p') togglePause();
  if(e.key.toLowerCase()==='r') restart();
  if(state===State.READY && (e.key===' '||e.key==='Enter')) start();
});
addEventListener('keyup',e=>{ if(e.key==='ArrowLeft') keys.delete('L'); if(e.key==='ArrowRight') keys.delete('R'); });

let pointerId=null;
canvas.addEventListener('pointerdown',e=>{
  const p=(e.changedTouches&&e.changedTouches[0])||e; pointerId=p.identifier??'mouse';
  if(state===State.READY) start();
  e.preventDefault();
},{passive:false});
addEventListener('pointermove',e=>{
  const p=(e.changedTouches && ([...e.changedTouches].find(t => (t.identifier ?? 'mouse')===pointerId)))||e; if(!p) return;
  const rect=canvas.getBoundingClientRect(); const cx=(p.clientX-rect.left)/rect.width*canvas.clientWidth;
  const diff=cx-chest.x; chest.vx=Math.max(-chest.speed, Math.min(chest.speed, diff*0.25)); e.preventDefault();
},{passive:false});
addEventListener('pointerup',()=>{pointerId=null; chest.vx=0;},{passive:false});
addEventListener('pointercancel',()=>{pointerId=null; chest.vx=0;},{passive:false});
addEventListener('blur',()=>{ if(state===State.PLAYING) togglePause(true); });

/* ====== Coins ====== */
const coins = [];
let spawnTimer = 0;
function spawnCoins(dt) {
  spawnTimer -= dt;
  const maxOnScreen = 5;
  if (spawnTimer <= 0 && coins.length < maxOnScreen) {
    const SAFE_MARGIN = chest.w * 0.12;
    coins.push({
      x: EDGE + SAFE_MARGIN + Math.random() * (canvas.clientWidth - 2 * (EDGE + SAFE_MARGIN)),
      y: -20,
      r: 12,
      vy: 2.6 + Math.random() * 2.2,
      spin: Math.random() * Math.PI * 2,
      vspin: -0.12 + Math.random() * 0.24
    });
    spawnTimer = 0.55 + Math.random() * 0.55;
  }
}

/* ====== Flow ====== */
function start(){
  score=0; timeLeft=TOTAL_TIME_SEC; missCount=0;
  coins.length=0; spawnTimer=0;
  chest.x=canvas.clientWidth/2; chest.vx=0; placeChest();
  state=State.PLAYING; panelStart.classList.add('hidden'); panelPause.classList.add('hidden'); panelWin.classList.add('hidden');
  refreshHUD(); btnPause.textContent='⏸ Pause';
}
function togglePause(forcePause){
  if(state===State.PLAYING && (forcePause??true)){ state=State.PAUSED; panelPause.classList.remove('hidden'); btnPause.textContent='⏵ Resume'; }
  else if(state===State.PAUSED){ state=State.PLAYING; panelPause.classList.add('hidden'); btnPause.textContent='⏸ Pause'; }
}
function restart(){
  panelWin.classList.add('hidden'); panelPause.classList.add('hidden');
  start();
}
function finishWin(){
  state=State.WIN;
  best=Math.max(best,Math.floor(score));
  localStorage.setItem('neox_catch_best_l1', String(best));
  localStorage.setItem('neox_last_score', String(Math.floor(score)));
  const prevTotal=Number(localStorage.getItem('neox_total_score')||0);
  localStorage.setItem('neox_total_score', String(prevTotal+Math.floor(score)));
  localStorage.setItem('neox_last_level','1');
  localStorage.setItem('nx_carry', String(Math.floor(score)));
  winTitle.textContent = "Stage Clear! 🎉";
  refreshHUD();
  btnNextLevel.classList.remove('hidden');
  panelWin.classList.remove('hidden'); SFX.win();
}
function finishOver(){
  state=State.OVER;
  best=Math.max(best,Math.floor(score));
  localStorage.setItem('neox_catch_best_l1', String(best));
  winTitle.textContent = "Game Over 🤭";
  refreshHUD();
  btnNextLevel.classList.add('hidden');
  panelWin.classList.remove('hidden'); SFX.over();
}

/* ====== Loop ====== */
let last=performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt=Math.min(50, now-last)/16.6667; last=now;

  drawBackground();

  if(state===State.PLAYING){
    timeLeft = Math.max(0, timeLeft - dt/60);
    if(timeLeft<=0){ return finishWin(); }

    chest.vx=(keys.has('L')?-chest.speed:0)+(keys.has('R')?chest.speed:0) || chest.vx*0.92;
    chest.x = Math.max(chest.w/2 + EDGE,
              Math.min(canvas.clientWidth - chest.w/2 - EDGE, chest.x + chest.vx));

    spawnCoins(dt);
    for(const c of coins){ c.y+=c.vy*dt; c.spin+=c.vspin*dt; }

    const baseRx = chest.w * 0.36, baseRy = chest.h * 0.18;
    const overhangL = Math.max(0, (chest.w/2 + EDGE) - chest.x);
    const overhangR = Math.max(0, (chest.w/2 + EDGE) - (canvas.clientWidth - chest.x));
    const edgeBoost = overhangL + overhangR + 4;
    const mouth = { cx: chest.x, cy: chest.y - chest.h * 0.58, rx: baseRx + edgeBoost, ry: baseRy };

    for (let i=coins.length-1; i>=0; i--){
      const c = coins[i];
      const ex = (c.x - mouth.cx) / mouth.rx;
      const ey = (c.y - mouth.cy) / mouth.ry;
      if (ex*ex + ey*ey <= 1){
        score += 10; coins.splice(i,1); SFX.star(); refreshHUD();
      } else if (c.y > canvas.clientHeight + 30){
        coins.splice(i,1);
        missCount++; SFX.miss(); refreshHUD();
        if(missCount>=MAX_MISSES){ return finishOver(); }
      }
    }
  }

  drawChest(); drawCoins();
}
requestAnimationFrame(loop);

/* ====== Render ====== */
function drawBackground(){
  const w=canvas.clientWidth,h=canvas.clientHeight; ctx.clearRect(0,0,w,h);
  if(!bgReady){
    const g=ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'#0f1240'); g.addColorStop(1,'#0a0c22');
    ctx.fillStyle=g; ctx.fillRect(0,0,w,h); return;
  }
  const iw=bgImg.width, ih=bgImg.height, ir=iw/ih, cr=w/h; let dw,dh,dx,dy;
  if(ir>cr){ dh=h; dw=h*ir; dx=(w-dw)/2; dy=0; } else { dw=w; dh=w/ir; dx=0; dy=(h-dh)/2; }
  ctx.drawImage(bgImg,dx,dy,dw,dh);
}
function drawChest(){
  const {x,y,w,h}=chest;
  const glow=ctx.createRadialGradient(x,y-24,6,x,y-24,120);
  glow.addColorStop(0,'rgba(43,124,255,0.30)'); glow.addColorStop(1,'rgba(43,124,255,0)');
  ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(x, y-24, 90, 0, Math.PI*2); ctx.fill();
  if(chestReady){ ctx.save(); ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=18; ctx.drawImage(chestImg, x-w/2, y-h, w, h); ctx.restore(); }
  else{ ctx.fillStyle='#1c274f'; ctx.fillRect(x-w/2, y-h, w, h); }
}
function drawCoins(){
  for(const c of coins){
    let size = c.r * 3;
    if (window.innerWidth < 600) size *= 0.7;
    const r = size / 2; ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.spin);
    if(coinReady){
      ctx.save(); ctx.shadowColor='rgba(255,223,128,.8)'; ctx.shadowBlur=18;
      ctx.drawImage(coinImg,-r,-r,size,size); ctx.restore();
    }else{
      const g=ctx.createRadialGradient(0,0,r*.2,0,0,r);
      g.addColorStop(0,'#fff6cc'); g.addColorStop(1,'#e3b23c');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }
}
</script>
</body>
</html>